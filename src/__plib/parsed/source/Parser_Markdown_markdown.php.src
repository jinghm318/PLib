<span style='color: #003366;'>&#60;?</span><span style='color: #000099;'><b>php</b></span><br/>
<span style='color: #0099CC;'>/**</span><br/>
<span style='color: #0099CC;'>&#160;*&#160;Markdown&#160;Extra&#160;&#160;-&#160;&#160;A&#160;text-to-HTML&#160;conversion&#160;tool&#160;for&#160;web&#160;writers</span><br/>
<span style='color: #0099CC;'>&#160;*</span><br/>
<span style='color: #0099CC;'>&#160;*&#160;PHP&#160;Markdown&#160;&#38;&#160;Extra</span><br/>
<span style='color: #0099CC;'>&#160;*&#160;Copyright&#160;(c)&#160;2004-2007&#160;Michel&#160;Fortin</span><br/>
<span style='color: #0099CC;'>&#160;*&#160;&#60;http://www.michelf.com/projects/php-markdown/&#62;</span><br/>
<span style='color: #0099CC;'>&#160;*</span><br/>
<span style='color: #0099CC;'>&#160;*&#160;Original&#160;Markdown</span><br/>
<span style='color: #0099CC;'>&#160;*&#160;Copyright&#160;(c)&#160;2004-2006&#160;John&#160;Gruber</span><br/>
<span style='color: #0099CC;'>&#160;*&#160;&#60;http://daringfireball.net/projects/markdown/&#62;</span><br/>
<span style='color: #0099CC;'>&#160;*</span><br/>
<span style='color: #0099CC;'>&#160;*&#160;@author&#160;Michel&#160;Fortin</span><br/>
<span style='color: #0099CC;'>&#160;*&#160;@author&#160;John&#160;Gruber</span><br/>
<span style='color: #0099CC;'>&#160;*&#160;@copyright&#160;2004-2007&#160;Michel&#160;Fortin</span><br/>
<span style='color: #0099CC;'>&#160;*&#160;@copyright&#160;2004-2006&#160;John&#160;Gruber</span><br/>
<span style='color: #0099CC;'>&#160;*&#160;@package&#160;Parser</span><br/>
<span style='color: #0099CC;'>&#160;*&#160;@subpackage&#160;Markdown</span><br/>
<span style='color: #0099CC;'>*/</span><br/>
&#160;<br/>
<span style='color: #ff0000;'>define</span><span style='color: #0000FF;'>(</span>&#160;<span style='color: #008800;'>&#39;MARKDOWN_VERSION&#39;</span><span style='color: #0000FF;'>,</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#34;1.0.1f&#34;</span>&#160;<span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span>&#160;<span style='color: #0099CC;'>#&#160;Wed&#160;7&#160;Feb&#160;2007</span><br/>
<span style='color: #ff0000;'>define</span><span style='color: #0000FF;'>(</span>&#160;<span style='color: #008800;'>&#39;MARKDOWNEXTRA_VERSION&#39;</span><span style='color: #0000FF;'>,</span>&#160;&#160;<span style='color: #008800;'>&#34;1.1.2&#34;</span>&#160;<span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span>&#160;&#160;<span style='color: #0099CC;'>#&#160;Wed&#160;7&#160;Feb&#160;2007</span><br/>
&#160;<br/>
&#160;<br/>
<span style='color: #0099CC;'>#</span><br/>
<span style='color: #0099CC;'>#&#160;Global&#160;default&#160;settings:</span><br/>
<span style='color: #0099CC;'>#</span><br/>
&#160;<br/>
<span style='color: #0099CC;'>#&#160;Change&#160;to&#160;&#34;&#62;&#34;&#160;for&#160;HTML&#160;output</span><br/>
<span style='color: #ff0000;'>define</span><span style='color: #0000FF;'>(</span>&#160;<span style='color: #008800;'>&#39;MARKDOWN_EMPTY_ELEMENT_SUFFIX&#39;</span><span style='color: #0000FF;'>,</span>&#160;&#160;<span style='color: #008800;'>&#34;&#160;/&#62;&#34;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
<span style='color: #0099CC;'>#&#160;Define&#160;the&#160;width&#160;of&#160;a&#160;tab&#160;for&#160;code&#160;blocks.</span><br/>
<span style='color: #ff0000;'>define</span><span style='color: #0000FF;'>(</span>&#160;<span style='color: #008800;'>&#39;MARKDOWN_TAB_WIDTH&#39;</span><span style='color: #0000FF;'>,</span>&#160;&#160;&#160;&#160;&#160;<span style='color: purple;'>4</span>&#160;<span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
<span style='color: #0099CC;'>#&#160;Optional&#160;title&#160;attribute&#160;for&#160;footnote&#160;links&#160;and&#160;backlinks.</span><br/>
<span style='color: #ff0000;'>define</span><span style='color: #0000FF;'>(</span>&#160;<span style='color: #008800;'>&#39;MARKDOWN_FN_LINK_TITLE&#39;</span><span style='color: #0000FF;'>,</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#34;&#34;</span>&#160;<span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
<span style='color: #ff0000;'>define</span><span style='color: #0000FF;'>(</span>&#160;<span style='color: #008800;'>&#39;MARKDOWN_FN_BACKLINK_TITLE&#39;</span><span style='color: #0000FF;'>,</span>&#160;&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#34;&#34;</span>&#160;<span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
<span style='color: #0099CC;'>#&#160;Optional&#160;class&#160;attribute&#160;for&#160;footnote&#160;links&#160;and&#160;backlinks.</span><br/>
<span style='color: #ff0000;'>define</span><span style='color: #0000FF;'>(</span>&#160;<span style='color: #008800;'>&#39;MARKDOWN_FN_LINK_CLASS&#39;</span><span style='color: #0000FF;'>,</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#34;&#34;</span>&#160;<span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
<span style='color: #ff0000;'>define</span><span style='color: #0000FF;'>(</span>&#160;<span style='color: #008800;'>&#39;MARKDOWN_FN_BACKLINK_CLASS&#39;</span><span style='color: #0000FF;'>,</span>&#160;&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#34;&#34;</span>&#160;<span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;<br/>
<span style='color: #0099CC;'>#</span><br/>
<span style='color: #0099CC;'>#&#160;WordPress&#160;settings:</span><br/>
<span style='color: #0099CC;'>#</span><br/>
&#160;<br/>
<span style='color: #0099CC;'>#&#160;Change&#160;to&#160;false&#160;to&#160;remove&#160;Markdown&#160;from&#160;posts&#160;and/or&#160;comments.</span><br/>
<span style='color: #ff0000;'>define</span><span style='color: #0000FF;'>(</span>&#160;<span style='color: #008800;'>&#39;MARKDOWN_WP_POSTS&#39;</span><span style='color: #0000FF;'>,</span>&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>true</b></span>&#160;<span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
<span style='color: #ff0000;'>define</span><span style='color: #0000FF;'>(</span>&#160;<span style='color: #008800;'>&#39;MARKDOWN_WP_COMMENTS&#39;</span><span style='color: #0000FF;'>,</span>&#160;&#160;&#160;<span style='color: #000099;'><b>true</b></span>&#160;<span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;<br/>
&#160;<br/>
<span style='color: #0099CC;'>###&#160;Standard&#160;Function&#160;Interface&#160;###</span><br/>
&#160;<br/>
<span style='color: #ff0000;'>define</span><span style='color: #0000FF;'>(</span>&#160;<span style='color: #008800;'>&#39;MARKDOWN_PARSER_CLASS&#39;</span><span style='color: #0000FF;'>,</span>&#160;&#160;<span style='color: #008800;'>&#39;MarkdownExtra_Parser&#39;</span>&#160;<span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
<span style='color: #000099;'><b>function</b></span>&#160;Markdown<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
<span style='color: #0099CC;'>#</span><br/>
<span style='color: #0099CC;'>#&#160;Initialize&#160;the&#160;parser&#160;and&#160;return&#160;the&#160;result&#160;of&#160;its&#160;transform&#160;method.</span><br/>
<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Setup&#160;static&#160;parser&#160;variable.</span><br/>
&#160;&#160;<span style='color: #000099;'><b>static</b></span>&#160;<span style='color: #990000;'><b>$parser</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>!</span><span style='color: #000099;'><b>isset</b></span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$parser</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$parser_class</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;MARKDOWN_PARSER_CLASS<span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$parser</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #000099;'><b>new</b></span>&#160;<span style='color: #990000;'><b>$parser_class</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Transform&#160;text&#160;using&#160;parser.</span><br/>
&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$parser</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>transform<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
<span style='color: #0099CC;'>###&#160;WordPress&#160;Plugin&#160;Interface&#160;###</span><br/>
&#160;<br/>
<span style='color: #0099CC;'>/*</span><br/>
<span style='color: #0099CC;'>Plugin&#160;Name:&#160;Markdown&#160;Extra</span><br/>
<span style='color: #0099CC;'>Plugin&#160;URI:&#160;http://www.michelf.com/projects/php-markdown/</span><br/>
<span style='color: #0099CC;'>Description:&#160;&#60;a&#160;href=&#34;http://daringfireball.net/projects/markdown/syntax&#34;&#62;Markdown&#160;syntax&#60;/a&#62;&#160;allows&#160;you&#160;to&#160;write&#160;using&#160;an&#160;easy-to-read,&#160;easy-to-write&#160;plain&#160;text&#160;format.&#160;Based&#160;on&#160;the&#160;original&#160;Perl&#160;version&#160;by&#160;&#60;a&#160;href=&#34;http://daringfireball.net/&#34;&#62;John&#160;Gruber&#60;/a&#62;.&#160;&#60;a&#160;href=&#34;http://www.michelf.com/projects/php-markdown/&#34;&#62;More...&#60;/a&#62;</span><br/>
<span style='color: #0099CC;'>Version:&#160;1.1.2</span><br/>
<span style='color: #0099CC;'>Author:&#160;Michel&#160;Fortin</span><br/>
<span style='color: #0099CC;'>Author&#160;URI:&#160;http://www.michelf.com/</span><br/>
<span style='color: #0099CC;'>*/</span><br/>
&#160;<br/>
<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #000099;'><b>isset</b></span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$wp_version</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;More&#160;details&#160;about&#160;how&#160;it&#160;works&#160;here:</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#60;http://www.michelf.com/weblog/2005/wordpress-text-flow-vs-markdown/&#62;</span><br/>
&#160;<br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Post&#160;content&#160;and&#160;excerpts</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;-&#160;Remove&#160;WordPress&#160;paragraph&#160;generator.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;-&#160;Run&#160;Markdown&#160;on&#160;excerpt,&#160;then&#160;remove&#160;all&#160;tags.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;-&#160;Add&#160;paragraph&#160;tag&#160;around&#160;the&#160;excerpt,&#160;but&#160;remove&#160;it&#160;for&#160;the&#160;excerpt&#160;rss.</span><br/>
&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span>MARKDOWN_WP_POSTS<span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;remove_filter<span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;the_content&#39;</span><span style='color: #0000FF;'>,</span>&#160;&#160;<span style='color: #008800;'>&#39;wpautop&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;remove_filter<span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;the_excerpt&#39;</span><span style='color: #0000FF;'>,</span>&#160;&#160;<span style='color: #008800;'>&#39;wpautop&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;add_filter<span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;the_content&#39;</span><span style='color: #0000FF;'>,</span>&#160;&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#39;Markdown&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: purple;'>6</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;add_filter<span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;get_the_excerpt&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;Markdown&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: purple;'>6</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;add_filter<span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;get_the_excerpt&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;trim&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: purple;'>7</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;add_filter<span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;the_excerpt&#39;</span><span style='color: #0000FF;'>,</span>&#160;&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#39;mdwp_add_p&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;add_filter<span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;the_excerpt_rss&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;mdwp_strip_p&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;remove_filter<span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;content_save_pre&#39;</span><span style='color: #0000FF;'>,</span>&#160;&#160;<span style='color: #008800;'>&#39;balanceTags&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: purple;'>50</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;remove_filter<span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;excerpt_save_pre&#39;</span><span style='color: #0000FF;'>,</span>&#160;&#160;<span style='color: #008800;'>&#39;balanceTags&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: purple;'>50</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;add_filter<span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;the_content&#39;</span><span style='color: #0000FF;'>,</span>&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#39;balanceTags&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: purple;'>50</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;add_filter<span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;get_the_excerpt&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;balanceTags&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: purple;'>9</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Comments</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;-&#160;Remove&#160;WordPress&#160;paragraph&#160;generator.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;-&#160;Remove&#160;WordPress&#160;auto-link&#160;generator.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;-&#160;Scramble&#160;important&#160;tags&#160;before&#160;passing&#160;them&#160;to&#160;the&#160;kses&#160;filter.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;-&#160;Run&#160;Markdown&#160;on&#160;excerpt&#160;then&#160;remove&#160;paragraph&#160;tags.</span><br/>
&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span>MARKDOWN_WP_COMMENTS<span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;remove_filter<span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;comment_text&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;wpautop&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;remove_filter<span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;comment_text&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;make_clickable&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;add_filter<span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;pre_comment_content&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;Markdown&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: purple;'>6</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;add_filter<span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;pre_comment_content&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;mdwp_hide_tags&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: purple;'>8</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;add_filter<span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;pre_comment_content&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;mdwp_show_tags&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: purple;'>12</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;add_filter<span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;get_comment_text&#39;</span><span style='color: #0000FF;'>,</span>&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#39;Markdown&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: purple;'>6</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;add_filter<span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;get_comment_excerpt&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;Markdown&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: purple;'>6</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;add_filter<span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;get_comment_excerpt&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;mdwp_strip_p&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: purple;'>7</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>global</b></span>&#160;<span style='color: #990000;'><b>$markdown_hidden_tags</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$markdown_hidden_tags</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#39;&#60;p&#62;&#39;</span>&#160;&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: #ff0000;'>md5</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;&#60;p&#62;&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#39;&#60;/p&#62;&#39;</span>&#160;&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: #ff0000;'>md5</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;&#60;/p&#62;&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#39;&#60;pre&#62;&#39;</span>&#160;&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: #ff0000;'>md5</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;&#60;pre&#62;&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;&#160;<span style='color: #008800;'>&#39;&#60;/pre&#62;&#39;</span><span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: #ff0000;'>md5</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;&#60;/pre&#62;&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#39;&#60;ol&#62;&#39;</span>&#160;&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: #ff0000;'>md5</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;&#60;ol&#62;&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#39;&#60;/ol&#62;&#39;</span>&#160;&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: #ff0000;'>md5</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;&#60;/ol&#62;&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#39;&#60;ul&#62;&#39;</span>&#160;&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: #ff0000;'>md5</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;&#60;ul&#62;&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#39;&#60;/ul&#62;&#39;</span>&#160;&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: #ff0000;'>md5</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;&#60;/ul&#62;&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#39;&#60;li&#62;&#39;</span>&#160;&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: #ff0000;'>md5</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;&#60;li&#62;&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#39;&#60;/li&#62;&#39;</span>&#160;&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: #ff0000;'>md5</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;&#60;/li&#62;&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;mdwp_add_p<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>!</span><span style='color: #ff0000;'>preg_match</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;{^$|^&#60;(p|ul|ol|dl|pre|blockquote)&#62;}i&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;&#60;p&#62;&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;&#60;/p&#62;&#39;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;{\n{2,}}&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#34;&#60;/p&#62;\n\n&#60;p&#62;&#34;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;mdwp_strip_p<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$t</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span>&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #ff0000;'>preg_replace</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;{&#60;/?p&#62;}i&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$t</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span>&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;mdwp_hide_tags<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>global</b></span>&#160;<span style='color: #990000;'><b>$markdown_hidden_tags</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #ff0000;'>str_replace</span><span style='color: #0000FF;'>(</span><span style='color: #ff0000;'>array_keys</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$markdown_hidden_tags</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #ff0000;'>array_values</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$markdown_hidden_tags</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;mdwp_show_tags<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>global</b></span>&#160;<span style='color: #990000;'><b>$markdown_hidden_tags</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #ff0000;'>str_replace</span><span style='color: #0000FF;'>(</span><span style='color: #ff0000;'>array_values</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$markdown_hidden_tags</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #ff0000;'>array_keys</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$markdown_hidden_tags</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
<span style='color: #0099CC;'>###&#160;bBlog&#160;Plugin&#160;Info&#160;###</span><br/>
&#160;<br/>
<span style='color: #000099;'><b>function</b></span>&#160;identify_modifier_markdown<span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#39;name&#39;</span>&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: #008800;'>&#39;markdown&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#39;type&#39;</span>&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: #008800;'>&#39;modifier&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#39;nicename&#39;</span>&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: #008800;'>&#39;PHP&#160;Markdown&#160;Extra&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#39;description&#39;</span>&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: #008800;'>&#39;A&#160;text-to-HTML&#160;conversion&#160;tool&#160;for&#160;web&#160;writers&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#39;authors&#39;</span>&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: #008800;'>&#39;Michel&#160;Fortin&#160;and&#160;John&#160;Gruber&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#39;licence&#39;</span>&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: #008800;'>&#39;GPL&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#39;version&#39;</span>&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;MARKDOWNEXTRA_VERSION<span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#39;help&#39;</span>&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: #008800;'>&#39;&#60;a&#160;href=&#34;http://daringfireball.net/projects/markdown/syntax&#34;&#62;Markdown&#160;syntax&#60;/a&#62;&#160;allows&#160;you&#160;to&#160;write&#160;using&#160;an&#160;easy-to-read,&#160;easy-to-write&#160;plain&#160;text&#160;format.&#160;Based&#160;on&#160;the&#160;original&#160;Perl&#160;version&#160;by&#160;&#60;a&#160;href=&#34;http://daringfireball.net/&#34;&#62;John&#160;Gruber&#60;/a&#62;.&#160;&#60;a&#160;href=&#34;http://www.michelf.com/projects/php-markdown/&#34;&#62;More...&#60;/a&#62;&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
<span style='color: #0099CC;'>###&#160;Smarty&#160;Modifier&#160;Interface&#160;###</span><br/>
&#160;<br/>
<span style='color: #000099;'><b>function</b></span>&#160;smarty_modifier_markdown<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;Markdown<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
<span style='color: #0099CC;'>###&#160;Textile&#160;Compatibility&#160;Mode&#160;###</span><br/>
&#160;<br/>
<span style='color: #0099CC;'>#&#160;Rename&#160;this&#160;file&#160;to&#160;&#34;classTextile.php&#34;&#160;and&#160;it&#160;can&#160;replace&#160;Textile&#160;everywhere.</span><br/>
<span style='color: #0099CC;'>/*</span><br/>
<span style='color: #0099CC;'>if&#160;(strcasecmp(substr(__FILE__,&#160;-16),&#160;&#34;classTextile.php&#34;)&#160;==&#160;0)&#160;{</span><br/>
<span style='color: #0099CC;'>&#160;&#160;#&#160;Try&#160;to&#160;include&#160;PHP&#160;SmartyPants.&#160;Should&#160;be&#160;in&#160;the&#160;same&#160;directory.</span><br/>
<span style='color: #0099CC;'>&#160;&#160;@include_once&#160;&#39;smartypants.php&#39;;</span><br/>
<span style='color: #0099CC;'>&#160;&#160;#&#160;Fake&#160;Textile&#160;class.&#160;It&#160;calls&#160;Markdown&#160;instead.</span><br/>
<span style='color: #0099CC;'>&#160;&#160;class&#160;Textile&#160;{</span><br/>
<span style='color: #0099CC;'>&#160;&#160;&#160;&#160;function&#160;TextileThis($text,&#160;$lite=&#39;&#39;,&#160;$encode=&#39;&#39;)&#160;{</span><br/>
<span style='color: #0099CC;'>&#160;&#160;&#160;&#160;&#160;&#160;if&#160;($lite&#160;==&#160;&#39;&#39;&#160;&#38;&#38;&#160;$encode&#160;==&#160;&#39;&#39;)&#160;&#160;&#160;&#160;$text&#160;=&#160;Markdown($text);</span><br/>
<span style='color: #0099CC;'>&#160;&#160;&#160;&#160;&#160;&#160;if&#160;(function_exists(&#39;SmartyPants&#39;))&#160;&#160;$text&#160;=&#160;SmartyPants($text);</span><br/>
<span style='color: #0099CC;'>&#160;&#160;&#160;&#160;&#160;&#160;return&#160;$text;</span><br/>
<span style='color: #0099CC;'>&#160;&#160;&#160;&#160;}</span><br/>
<span style='color: #0099CC;'>&#160;&#160;&#160;&#160;#&#160;Fake&#160;restricted&#160;version:&#160;restrictions&#160;are&#160;not&#160;supported&#160;for&#160;now.</span><br/>
<span style='color: #0099CC;'>&#160;&#160;&#160;&#160;function&#160;TextileRestricted($text,&#160;$lite=&#39;&#39;,&#160;$noimage=&#39;&#39;)&#160;{</span><br/>
<span style='color: #0099CC;'>&#160;&#160;&#160;&#160;&#160;&#160;return&#160;$this-&#62;TextileThis($text,&#160;$lite);</span><br/>
<span style='color: #0099CC;'>&#160;&#160;&#160;&#160;}</span><br/>
<span style='color: #0099CC;'>&#160;&#160;&#160;&#160;#&#160;Workaround&#160;to&#160;ensure&#160;compatibility&#160;with&#160;TextPattern&#160;4.0.3.</span><br/>
<span style='color: #0099CC;'>&#160;&#160;&#160;&#160;function&#160;blockLite($text)&#160;{&#160;return&#160;$text;&#160;}</span><br/>
<span style='color: #0099CC;'>&#160;&#160;}</span><br/>
<span style='color: #0099CC;'>}</span><br/>
<span style='color: #0099CC;'>*/</span><br/>
&#160;<br/>
&#160;<br/>
<span style='color: #0099CC;'>#</span><br/>
<span style='color: #0099CC;'>#&#160;Markdown&#160;Parser&#160;Class</span><br/>
<span style='color: #0099CC;'>#</span><br/>
&#160;<br/>
<span style='color: #000099;'><b>class</b></span>&#160;Markdown_Parser&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;<br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Regex&#160;to&#160;match&#160;balanced&#160;[brackets].</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Needed&#160;to&#160;insert&#160;a&#160;maximum&#160;bracked&#160;depth&#160;while&#160;converting&#160;to&#160;PHP.</span><br/>
&#160;&#160;<span style='color: #000099;'><b>var</b></span>&#160;<span style='color: #990000;'><b>$nested_brackets_depth</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: purple;'>6</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #000099;'><b>var</b></span>&#160;<span style='color: #990000;'><b>$nested_brackets</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Table&#160;of&#160;hash&#160;values&#160;for&#160;escaped&#160;characters:</span><br/>
&#160;&#160;<span style='color: #000099;'><b>var</b></span>&#160;<span style='color: #990000;'><b>$escape_chars</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;\`*_{}[]()&#62;#+-.!&#39;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #000099;'><b>var</b></span>&#160;<span style='color: #990000;'><b>$escape_table</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #000099;'><b>var</b></span>&#160;<span style='color: #990000;'><b>$backslash_escape_table</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Change&#160;to&#160;&#34;&#62;&#34;&#160;for&#160;HTML&#160;output.</span><br/>
&#160;&#160;<span style='color: #000099;'><b>var</b></span>&#160;<span style='color: #990000;'><b>$empty_element_suffix</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;MARKDOWN_EMPTY_ELEMENT_SUFFIX<span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #000099;'><b>var</b></span>&#160;<span style='color: #990000;'><b>$tab_width</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;MARKDOWN_TAB_WIDTH<span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;Markdown_Parser<span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Constructor&#160;function.&#160;Initialize&#160;appropriate&#160;member&#160;variables.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>_initDetab<span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>nested_brackets&#160;<span style='color: #0000FF;'>=</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #ff0000;'>str_repeat</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;(?&#62;[^\[\]]+|\[&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>nested_brackets_depth<span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #ff0000;'>str_repeat</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;\])*&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>nested_brackets_depth<span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Create&#160;an&#160;identical&#160;table&#160;but&#160;for&#160;escaped&#160;characters.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>foreach</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #ff0000;'>preg_split</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;/(?!^|$)/&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>escape_chars<span style='color: #0000FF;'>)</span>&#160;<span style='color: #000099;'><b>as</b></span>&#160;<span style='color: #990000;'><b>$char</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$hash</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>md5</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$char</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>escape_table<span style='color: #0000FF;'>[</span><span style='color: #990000;'><b>$char</b></span><span style='color: #0000FF;'>]</span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$hash</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>backslash_escape_table<span style='color: #0000FF;'>[</span><span style='color: #008800;'>&#34;\\$char&#34;</span><span style='color: #0000FF;'>]</span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$hash</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Sort&#160;document,&#160;block,&#160;and&#160;span&#160;gamut&#160;in&#160;ascendent&#160;priority&#160;order.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #ff0000;'>asort</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>document_gamut<span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #ff0000;'>asort</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>block_gamut<span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #ff0000;'>asort</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>span_gamut<span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Internal&#160;hashes&#160;used&#160;during&#160;transformation.</span><br/>
&#160;&#160;<span style='color: #000099;'><b>var</b></span>&#160;<span style='color: #990000;'><b>$urls</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #000099;'><b>var</b></span>&#160;<span style='color: #990000;'><b>$titles</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #000099;'><b>var</b></span>&#160;<span style='color: #990000;'><b>$html_blocks</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #000099;'><b>var</b></span>&#160;<span style='color: #990000;'><b>$html_hashes</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span>&#160;<span style='color: #0099CC;'>#&#160;Contains&#160;both&#160;blocks&#160;and&#160;span&#160;hashes.</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;transform<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Main&#160;function.&#160;The&#160;order&#160;in&#160;which&#160;other&#160;subs&#160;are&#160;called&#160;here&#160;is</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;essential.&#160;Link&#160;and&#160;image&#160;substitutions&#160;need&#160;to&#160;happen&#160;before</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;_EscapeSpecialCharsWithinTagAttributes(),&#160;so&#160;that&#160;any&#160;*&#39;s&#160;or&#160;_&#39;s&#160;in&#160;the&#160;&#60;a&#62;</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;and&#160;&#60;img&#62;&#160;tags&#160;get&#160;encoded.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Clear&#160;the&#160;global&#160;hashes.&#160;If&#160;we&#160;don&#39;t&#160;clear&#160;these,&#160;you&#160;get&#160;conflicts</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;from&#160;other&#160;articles&#160;when&#160;generating&#160;a&#160;page&#160;which&#160;contains&#160;more&#160;than</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;one&#160;article&#160;(e.g.&#160;an&#160;index&#160;page&#160;that&#160;shows&#160;the&#160;N&#160;most&#160;recent</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;articles):</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>urls&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>titles&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>html_blocks&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>html_hashes&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Standardize&#160;line&#160;endings:</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;DOS&#160;to&#160;Unix&#160;and&#160;Mac&#160;to&#160;Unix</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>str_replace</span><span style='color: #0000FF;'>(</span><span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#34;\r\n&#34;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#34;\r&#34;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#34;\n&#34;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Make&#160;sure&#160;$text&#160;ends&#160;with&#160;a&#160;couple&#160;of&#160;newlines:</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;\n\n&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Convert&#160;all&#160;tabs&#160;to&#160;spaces.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>detab<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Turn&#160;block-level&#160;HTML&#160;blocks&#160;into&#160;hash&#160;entries</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>hashHTMLBlocks<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Strip&#160;any&#160;lines&#160;consisting&#160;only&#160;of&#160;spaces&#160;and&#160;tabs.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;This&#160;makes&#160;subsequent&#160;regexen&#160;easier&#160;to&#160;write,&#160;because&#160;we&#160;can</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;match&#160;consecutive&#160;blank&#160;lines&#160;with&#160;/\n+/&#160;instead&#160;of&#160;something</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;contorted&#160;like&#160;/[&#160;\t]*\n+/&#160;.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;/^[&#160;\t]+$/m&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Run&#160;document&#160;gamut&#160;methods.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>foreach</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>document_gamut&#160;<span style='color: #000099;'><b>as</b></span>&#160;<span style='color: #990000;'><b>$method</b></span>&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: #990000;'><b>$priority</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span><span style='color: #990000;'><b>$method</b></span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>.</span>&#160;<span style='color: #008800;'>&#34;\n&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>var</b></span>&#160;<span style='color: #990000;'><b>$document_gamut</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Strip&#160;link&#160;definitions,&#160;store&#160;in&#160;hashes.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#34;stripLinkDefinitions&#34;</span>&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: purple;'>20</span><span style='color: #0000FF;'>,</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#34;runBasicBlockGamut&#34;</span>&#160;&#160;&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: purple;'>30</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#34;unescapeSpecialChars&#34;</span>&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: purple;'>90</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;stripLinkDefinitions<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Strips&#160;link&#160;definitions&#160;from&#160;text,&#160;stores&#160;the&#160;URLs&#160;and&#160;titles&#160;in</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;hash&#160;references.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$less_than_tab</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>tab_width&#160;<span style='color: #0000FF;'>-</span>&#160;<span style='color: purple;'>1</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Link&#160;defs&#160;are&#160;in&#160;the&#160;form:&#160;^[id]:&#160;url&#160;&#34;optional&#160;title&#34;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace_callback</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;{</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;^[&#160;]{0,&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$less_than_tab</b></span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;}\[(.+)\][&#160;]?:&#160;&#160;#&#160;id&#160;=&#160;$1</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#160;\t]*</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\n?&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;maybe&#160;*one*&#160;newline</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#160;\t]*</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#60;?(\S+?)&#62;?&#160;&#160;&#160;&#160;&#160;&#160;#&#160;url&#160;=&#160;$2</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#160;\t]*</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\n?&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;maybe&#160;one&#160;newline</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#160;\t]*</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?:</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?&#60;=\s)&#160;&#160;&#160;&#160;&#160;&#160;#&#160;lookbehind&#160;for&#160;whitespace</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#34;(]</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(.*?)&#160;&#160;&#160;&#160;&#160;&#160;#&#160;title&#160;=&#160;$3</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#34;)]</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#160;\t]*</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)?&#160;&#160;#&#160;title&#160;is&#160;optional</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?:\n+|\Z)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;}xm&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>&#38;</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;_stripLinkDefinitions_callback&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;_stripLinkDefinitions_callback<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$link_id</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>strtolower</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>urls<span style='color: #0000FF;'>[</span><span style='color: #990000;'><b>$link_id</b></span><span style='color: #0000FF;'>]</span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>encodeAmpsAndAngles<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>2</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #000099;'><b>isset</b></span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>3</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>titles<span style='color: #0000FF;'>[</span><span style='color: #990000;'><b>$link_id</b></span><span style='color: #0000FF;'>]</span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>str_replace</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;&#34;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;&#38;quot;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>3</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #008800;'>&#39;&#39;</span><span style='color: #0000FF;'>;</span>&#160;<span style='color: #0099CC;'>#&#160;String&#160;that&#160;will&#160;replace&#160;the&#160;block</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;hashHTMLBlocks<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$less_than_tab</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>tab_width&#160;<span style='color: #0000FF;'>-</span>&#160;<span style='color: purple;'>1</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Hashify&#160;HTML&#160;blocks:</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;We&#160;only&#160;want&#160;to&#160;do&#160;this&#160;for&#160;block-level&#160;HTML&#160;tags,&#160;such&#160;as&#160;headers,</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;lists,&#160;and&#160;tables.&#160;That&#39;s&#160;because&#160;we&#160;still&#160;want&#160;to&#160;wrap&#160;&#60;p&#62;s&#160;around</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#34;paragraphs&#34;&#160;that&#160;are&#160;wrapped&#160;in&#160;non-block-level&#160;tags,&#160;such&#160;as&#160;anchors,</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;phrase&#160;emphasis,&#160;and&#160;spans.&#160;The&#160;list&#160;of&#160;tags&#160;we&#39;re&#160;looking&#160;for&#160;is</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;hard-coded:</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$block_tags_a</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|address|&#39;</span><span style='color: #0000FF;'>.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#39;script|noscript|form|fieldset|iframe|math|ins|del&#39;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$block_tags_b</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|address|&#39;</span><span style='color: #0000FF;'>.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#39;script|noscript|form|fieldset|iframe|math&#39;</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Regular&#160;expression&#160;for&#160;the&#160;content&#160;of&#160;a&#160;block&#160;tag.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$nested_tags_level</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: purple;'>4</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$attr</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;(?&#62;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;optional&#160;tag&#160;attributes</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\s&#160;&#160;&#160;&#160;&#160;&#160;#&#160;starts&#160;with&#160;whitespace</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?&#62;</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[^&#62;&#34;/]+&#160;&#160;&#160;&#160;#&#160;text&#160;outside&#160;quotes</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;|</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;/+(?!&#62;)&#160;&#160;&#160;&#160;#&#160;slash&#160;not&#160;followed&#160;by&#160;&#34;&#62;&#34;</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;|</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#34;[^&#34;]*&#34;&#160;&#160;&#160;&#160;#&#160;text&#160;inside&#160;double&#160;quotes&#160;(tolerate&#160;&#34;&#62;&#34;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;|</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\&#39;[^\&#39;]*\&#39;&#160;&#160;#&#160;text&#160;inside&#160;single&#160;quotes&#160;(tolerate&#160;&#34;&#62;&#34;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)*</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;)?</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#39;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$content</b></span>&#160;<span style='color: #0000FF;'>=</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #ff0000;'>str_repeat</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?&#62;</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[^&#60;]+&#160;&#160;&#160;&#160;&#160;&#160;#&#160;content&#160;without&#160;tag</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;|</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#60;\2&#160;&#160;&#160;&#160;&#160;&#160;#&#160;nested&#160;opening&#160;tag</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$attr</b></span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;&#160;&#160;#&#160;attributes</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?:</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;/&#62;</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;|</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#62;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$nested_tags_level</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>.</span>&#160;&#160;<span style='color: #0099CC;'>#&#160;end&#160;of&#160;opening&#160;tag</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#39;.*?&#39;</span><span style='color: #0000FF;'>.</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;last&#160;level&#160;nested&#160;tag&#160;content</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #ff0000;'>str_repeat</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#60;/\2\s*&#62;&#160;&#160;#&#160;closing&#160;nested&#160;tag</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;|</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#60;(?!/\2\s*&#62;&#160;&#160;#&#160;other&#160;tags&#160;with&#160;a&#160;different&#160;name</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)*&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$nested_tags_level</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;First,&#160;look&#160;for&#160;nested&#160;blocks,&#160;e.g.:</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#60;div&#62;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;&#160;&#60;div&#62;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;&#160;tags&#160;for&#160;inner&#160;block&#160;must&#160;be&#160;indented.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;&#160;&#60;/div&#62;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#60;/div&#62;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;The&#160;outermost&#160;tags&#160;must&#160;start&#160;at&#160;the&#160;left&#160;margin&#160;for&#160;this&#160;to&#160;match,&#160;and</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;the&#160;inner&#160;nested&#160;divs&#160;must&#160;be&#160;indented.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;We&#160;need&#160;to&#160;do&#160;this&#160;before&#160;the&#160;next,&#160;more&#160;liberal&#160;match,&#160;because&#160;the&#160;next</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;match&#160;will&#160;start&#160;at&#160;the&#160;first&#160;`&#60;div&#62;`&#160;and&#160;stop&#160;at&#160;the&#160;first&#160;`&#60;/div&#62;`.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace_callback</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;{</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;save&#160;in&#160;$1</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;^&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;start&#160;of&#160;line&#160;&#160;(with&#160;/m)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#60;(&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$block_tags_a</b></span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;)#&#160;start&#160;tag&#160;=&#160;$2</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$attr</b></span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;&#62;\n&#160;&#160;&#160;&#160;#&#160;attributes&#160;followed&#160;by&#160;&#62;&#160;and&#160;\n</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$content</b></span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;&#160;&#160;&#160;&#160;#&#160;content,&#160;support&#160;nesting</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#60;/\2&#62;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;the&#160;matching&#160;end&#160;tag</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#160;\t]*&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;trailing&#160;spaces/tabs</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?=\n+|\Z)&#160;&#160;#&#160;followed&#160;by&#160;a&#160;newline&#160;or&#160;end&#160;of&#160;document</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;}xm&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>&#38;</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;_hashHTMLBlocks_callback&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Match&#160;from&#160;`\n&#60;tag&#62;`&#160;to&#160;`&#60;/tag&#62;\n`,&#160;handling&#160;nested&#160;tags&#160;in&#160;between.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace_callback</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;{</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;save&#160;in&#160;$1</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;^&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;start&#160;of&#160;line&#160;&#160;(with&#160;/m)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#60;(&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$block_tags_b</b></span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;)#&#160;start&#160;tag&#160;=&#160;$2</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$attr</b></span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;&#62;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;attributes&#160;followed&#160;by&#160;&#62;</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$content</b></span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;&#160;&#160;&#160;&#160;#&#160;content,&#160;support&#160;nesting</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#60;/\2&#62;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;the&#160;matching&#160;end&#160;tag</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#160;\t]*&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;trailing&#160;spaces/tabs</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?=\n+|\Z)&#160;&#160;#&#160;followed&#160;by&#160;a&#160;newline&#160;or&#160;end&#160;of&#160;document</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;}xm&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>&#38;</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;_hashHTMLBlocks_callback&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Special&#160;case&#160;just&#160;for&#160;&#60;hr&#160;/&#62;.&#160;It&#160;was&#160;easier&#160;to&#160;make&#160;a&#160;special&#160;case&#160;than</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;to&#160;make&#160;the&#160;other&#160;regex&#160;more&#160;complicated.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace_callback</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;{</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?:</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?&#60;=\n\n)&#160;&#160;&#160;&#160;#&#160;Starting&#160;after&#160;a&#160;blank&#160;line</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;|&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;or</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\A\n?&#160;&#160;&#160;&#160;&#160;&#160;#&#160;the&#160;beginning&#160;of&#160;the&#160;doc</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;save&#160;in&#160;$1</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#160;]{0,&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$less_than_tab</b></span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;}</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#60;(hr)&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;start&#160;tag&#160;=&#160;$2</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\b&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;word&#160;break</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;([^&#60;&#62;])*?&#160;&#160;&#160;&#160;&#160;&#160;#</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;/?&#62;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;the&#160;matching&#160;end&#160;tag</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#160;\t]*</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?=\n{2,}|\Z)&#160;&#160;&#160;&#160;#&#160;followed&#160;by&#160;a&#160;blank&#160;line&#160;or&#160;end&#160;of&#160;document</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;}x&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>&#38;</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;_hashHTMLBlocks_callback&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Special&#160;case&#160;for&#160;standalone&#160;HTML&#160;comments:</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace_callback</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;{</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?:</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?&#60;=\n\n)&#160;&#160;&#160;&#160;#&#160;Starting&#160;after&#160;a&#160;blank&#160;line</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;|&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;or</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\A\n?&#160;&#160;&#160;&#160;&#160;&#160;#&#160;the&#160;beginning&#160;of&#160;the&#160;doc</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;save&#160;in&#160;$1</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#160;]{0,&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$less_than_tab</b></span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;}</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?s:</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#60;!--&#160;.*?&#160;--&#62;</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#160;\t]*</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?=\n{2,}|\Z)&#160;&#160;&#160;&#160;#&#160;followed&#160;by&#160;a&#160;blank&#160;line&#160;or&#160;end&#160;of&#160;document</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;}x&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>&#38;</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;_hashHTMLBlocks_callback&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;PHP&#160;and&#160;ASP-style&#160;processor&#160;instructions&#160;(&#60;?&#160;and&#160;&#60;%)</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace_callback</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;{</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?:</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?&#60;=\n\n)&#160;&#160;&#160;&#160;#&#160;Starting&#160;after&#160;a&#160;blank&#160;line</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;|&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;or</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\A\n?&#160;&#160;&#160;&#160;&#160;&#160;#&#160;the&#160;beginning&#160;of&#160;the&#160;doc</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;save&#160;in&#160;$1</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#160;]{0,&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$less_than_tab</b></span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;}</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?s:</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#60;([?%])&#160;&#160;&#160;&#160;&#160;&#160;#&#160;$2</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;.*?</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\2&#62;</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#160;\t]*</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?=\n{2,}|\Z)&#160;&#160;&#160;&#160;#&#160;followed&#160;by&#160;a&#160;blank&#160;line&#160;or&#160;end&#160;of&#160;document</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;}x&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>&#38;</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;_hashHTMLBlocks_callback&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;_hashHTMLBlocks_callback<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$key</b></span>&#160;&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>hashBlock<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #008800;'>&#34;\n\n$key\n\n&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;hashBlock<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Called&#160;whenever&#160;a&#160;tag&#160;must&#160;be&#160;hashed&#160;when&#160;a&#160;function&#160;insert&#160;a&#160;block-level</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;tag&#160;in&#160;$text,&#160;it&#160;pass&#160;through&#160;this&#160;function&#160;and&#160;is&#160;automaticaly&#160;escaped,</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;which&#160;remove&#160;the&#160;need&#160;to&#160;call&#160;_HashHTMLBlocks&#160;at&#160;every&#160;step.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Swap&#160;back&#160;any&#160;tag&#160;hash&#160;found&#160;in&#160;$text&#160;so&#160;we&#160;do&#160;not&#160;have&#160;to&#160;`unhash`</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;multiple&#160;times&#160;at&#160;the&#160;end.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>unhash<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Then&#160;hash&#160;the&#160;block.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$key</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>md5</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>html_hashes<span style='color: #0000FF;'>[</span><span style='color: #990000;'><b>$key</b></span><span style='color: #0000FF;'>]</span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>html_blocks<span style='color: #0000FF;'>[</span><span style='color: #990000;'><b>$key</b></span><span style='color: #0000FF;'>]</span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$key</b></span><span style='color: #0000FF;'>;</span>&#160;<span style='color: #0099CC;'>#&#160;String&#160;that&#160;will&#160;replace&#160;the&#160;tag.</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;hashSpan<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Called&#160;whenever&#160;a&#160;tag&#160;must&#160;be&#160;hashed&#160;when&#160;a&#160;function&#160;insert&#160;a&#160;span-level</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;element&#160;in&#160;$text,&#160;it&#160;pass&#160;through&#160;this&#160;function&#160;and&#160;is&#160;automaticaly</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;escaped,&#160;blocking&#160;invalid&#160;nested&#160;overlap.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Swap&#160;back&#160;any&#160;tag&#160;hash&#160;found&#160;in&#160;$text&#160;so&#160;we&#160;do&#160;not&#160;have&#160;to&#160;`unhash`</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;multiple&#160;times&#160;at&#160;the&#160;end.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>unhash<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Then&#160;hash&#160;the&#160;span.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$key</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>md5</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>html_hashes<span style='color: #0000FF;'>[</span><span style='color: #990000;'><b>$key</b></span><span style='color: #0000FF;'>]</span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$key</b></span><span style='color: #0000FF;'>;</span>&#160;<span style='color: #0099CC;'>#&#160;String&#160;that&#160;will&#160;replace&#160;the&#160;span&#160;tag.</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>var</b></span>&#160;<span style='color: #990000;'><b>$block_gamut</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;These&#160;are&#160;all&#160;the&#160;transformations&#160;that&#160;form&#160;block-level</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;tags&#160;like&#160;paragraphs,&#160;headers,&#160;and&#160;list&#160;items.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#34;doHeaders&#34;</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: purple;'>10</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#34;doHorizontalRules&#34;</span>&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: purple;'>20</span><span style='color: #0000FF;'>,</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#34;doLists&#34;</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: purple;'>40</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#34;doCodeBlocks&#34;</span>&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: purple;'>50</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#34;doBlockQuotes&#34;</span>&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: purple;'>60</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;runBlockGamut<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Run&#160;block&#160;gamut&#160;tranformations.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;We&#160;need&#160;to&#160;escape&#160;raw&#160;HTML&#160;in&#160;Markdown&#160;source&#160;before&#160;doing&#160;anything</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;else.&#160;This&#160;need&#160;to&#160;be&#160;done&#160;for&#160;each&#160;block,&#160;and&#160;not&#160;only&#160;at&#160;the</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;begining&#160;in&#160;the&#160;Markdown&#160;function&#160;since&#160;hashed&#160;blocks&#160;can&#160;be&#160;part&#160;of</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;list&#160;items&#160;and&#160;could&#160;have&#160;been&#160;indented.&#160;Indented&#160;blocks&#160;would&#160;have</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;been&#160;seen&#160;as&#160;a&#160;code&#160;block&#160;in&#160;a&#160;previous&#160;pass&#160;of&#160;hashHTMLBlocks.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>hashHTMLBlocks<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>runBasicBlockGamut<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;runBasicBlockGamut<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Run&#160;block&#160;gamut&#160;tranformations,&#160;without&#160;hashing&#160;HTML&#160;blocks.&#160;This&#160;is</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;useful&#160;when&#160;HTML&#160;blocks&#160;are&#160;known&#160;to&#160;be&#160;already&#160;hashed,&#160;like&#160;in&#160;the&#160;first</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;whole-document&#160;pass.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>foreach</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>block_gamut&#160;<span style='color: #000099;'><b>as</b></span>&#160;<span style='color: #990000;'><b>$method</b></span>&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: #990000;'><b>$priority</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span><span style='color: #990000;'><b>$method</b></span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Finally&#160;form&#160;paragraph&#160;and&#160;restore&#160;hashed&#160;blocks.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>formParagraphs<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;doHorizontalRules<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Do&#160;Horizontal&#160;Rules:</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #ff0000;'>preg_replace</span><span style='color: #0000FF;'>(</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;{^[&#160;]{0,2}([&#160;]?\*[&#160;]?){3,}[&#160;\t]*$}mx&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#39;{^[&#160;]{0,2}([&#160;]?&#160;-[&#160;]?){3,}[&#160;\t]*$}mx&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#39;{^[&#160;]{0,2}([&#160;]?&#160;_[&#160;]?){3,}[&#160;\t]*$}mx&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#34;\n&#34;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>hashBlock<span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#34;&#60;hr$this-&#62;empty_element_suffix&#34;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#34;\n&#34;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>var</b></span>&#160;<span style='color: #990000;'><b>$span_gamut</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;These&#160;are&#160;all&#160;the&#160;transformations&#160;that&#160;occur&#160;*within*&#160;block-level</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;tags&#160;like&#160;paragraphs,&#160;headers,&#160;and&#160;list&#160;items.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#34;escapeSpecialCharsWithinTagAttributes&#34;</span>&#160;&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: #0000FF;'>-</span><span style='color: purple;'>20</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#34;doCodeSpans&#34;</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: #0000FF;'>-</span><span style='color: purple;'>10</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#34;encodeBackslashEscapes&#34;</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;&#160;<span style='color: #0000FF;'>-</span><span style='color: purple;'>5</span><span style='color: #0000FF;'>,</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Process&#160;anchor&#160;and&#160;image&#160;tags.&#160;Images&#160;must&#160;come&#160;first,</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;because&#160;![foo][f]&#160;looks&#160;like&#160;an&#160;anchor.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#34;doImages&#34;</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;&#160;<span style='color: purple;'>10</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#34;doAnchors&#34;</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;&#160;<span style='color: purple;'>20</span><span style='color: #0000FF;'>,</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Make&#160;links&#160;out&#160;of&#160;things&#160;like&#160;`&#60;http://example.com/&#62;`</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Must&#160;come&#160;after&#160;doAnchors,&#160;because&#160;you&#160;can&#160;use&#160;&#60;&#160;and&#160;&#62;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;delimiters&#160;in&#160;inline&#160;links&#160;like&#160;[this](&#60;url&#62;).</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#34;doAutoLinks&#34;</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;&#160;<span style='color: purple;'>30</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#34;encodeAmpsAndAngles&#34;</span>&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;&#160;<span style='color: purple;'>40</span><span style='color: #0000FF;'>,</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#34;doItalicsAndBold&#34;</span>&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;&#160;<span style='color: purple;'>50</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#34;doHardBreaks&#34;</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;&#160;<span style='color: purple;'>60</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;runSpanGamut<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Run&#160;span&#160;gamut&#160;tranformations.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>foreach</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>span_gamut&#160;<span style='color: #000099;'><b>as</b></span>&#160;<span style='color: #990000;'><b>$method</b></span>&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: #990000;'><b>$priority</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span><span style='color: #990000;'><b>$method</b></span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;doHardBreaks<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Do&#160;hard&#160;breaks:</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$br_tag</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>hashSpan<span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#34;&#60;br$this-&#62;empty_element_suffix\n&#34;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #ff0000;'>preg_replace</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;/&#160;{2,}\n/&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$br_tag</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;escapeSpecialCharsWithinTagAttributes<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Within&#160;tags&#160;--&#160;meaning&#160;between&#160;&#60;&#160;and&#160;&#62;&#160;--&#160;encode&#160;[\&#160;`&#160;*&#160;_]&#160;so&#160;they</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;don&#39;t&#160;conflict&#160;with&#160;their&#160;use&#160;in&#160;Markdown&#160;for&#160;code,&#160;italics&#160;and&#160;strong.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;We&#39;re&#160;replacing&#160;each&#160;such&#160;character&#160;with&#160;its&#160;corresponding&#160;MD5&#160;checksum</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;value;&#160;this&#160;is&#160;likely&#160;overkill,&#160;but&#160;it&#160;should&#160;prevent&#160;us&#160;from&#160;colliding</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;with&#160;the&#160;escape&#160;values&#160;by&#160;accident.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$tokens</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>tokenizeHTML<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;&#39;</span><span style='color: #0000FF;'>;</span>&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;rebuild&#160;$text&#160;from&#160;the&#160;tokens</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>foreach</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$tokens</b></span>&#160;<span style='color: #000099;'><b>as</b></span>&#160;<span style='color: #990000;'><b>$cur_token</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$cur_token</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>0</span><span style='color: #0000FF;'>]</span>&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;tag&#39;</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$cur_token</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>str_replace</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;\\&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>escape_table<span style='color: #0000FF;'>[</span><span style='color: #008800;'>&#39;\\&#39;</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$cur_token</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$cur_token</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>str_replace</span><span style='color: #0000FF;'>(</span><span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;`&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>escape_table<span style='color: #0000FF;'>[</span><span style='color: #008800;'>&#39;`&#39;</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$cur_token</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$cur_token</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>str_replace</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;*&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>escape_table<span style='color: #0000FF;'>[</span><span style='color: #008800;'>&#39;*&#39;</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$cur_token</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$cur_token</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>str_replace</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;_&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>escape_table<span style='color: #0000FF;'>[</span><span style='color: #008800;'>&#39;_&#39;</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$cur_token</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$cur_token</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;doAnchors<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Turn&#160;Markdown&#160;link&#160;shortcuts&#160;into&#160;XHTML&#160;&#60;a&#62;&#160;tags.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;First,&#160;handle&#160;reference-style&#160;links:&#160;[link&#160;text]&#160;[id]</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace_callback</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;{</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;(&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;wrap&#160;whole&#160;match&#160;in&#160;$1</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\[</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>nested_brackets<span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;)&#160;&#160;#&#160;link&#160;text&#160;=&#160;$2</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\]</span><br/>
<span style='color: #008800;'>&#160;</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#160;]?&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;one&#160;optional&#160;space</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?:\n[&#160;]*)?&#160;&#160;&#160;&#160;#&#160;one&#160;optional&#160;newline&#160;followed&#160;by&#160;spaces</span><br/>
<span style='color: #008800;'>&#160;</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\[</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(.*?)&#160;&#160;&#160;&#160;#&#160;id&#160;=&#160;$3</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\]</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;}xs&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>&#38;</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;_doAnchors_reference_callback&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Next,&#160;inline-style&#160;links:&#160;[link&#160;text](url&#160;&#34;optional&#160;title&#34;)</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace_callback</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;{</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;(&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;wrap&#160;whole&#160;match&#160;in&#160;$1</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\[</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>nested_brackets<span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;)&#160;&#160;#&#160;link&#160;text&#160;=&#160;$2</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\]</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\(&#160;&#160;&#160;&#160;&#160;&#160;#&#160;literal&#160;paren</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#160;\t]*</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#60;?(.*?)&#62;?&#160;&#160;#&#160;href&#160;=&#160;$3</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#160;\t]*</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(&#160;&#160;&#160;&#160;&#160;&#160;#&#160;$4</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;([\&#39;&#34;])&#160;&#160;#&#160;quote&#160;char&#160;=&#160;$5</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(.*?)&#160;&#160;&#160;&#160;#&#160;Title&#160;=&#160;$6</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\5&#160;&#160;&#160;&#160;#&#160;matching&#160;quote</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#160;\t]*&#160;&#160;#&#160;ignore&#160;any&#160;spaces/tabs&#160;between&#160;closing&#160;quote&#160;and&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)?&#160;&#160;&#160;&#160;&#160;&#160;#&#160;title&#160;is&#160;optional</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;}xs&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>&#38;</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;_DoAnchors_inline_callback&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Last,&#160;handle&#160;reference-style&#160;shortcuts:&#160;[link&#160;text]</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;These&#160;must&#160;come&#160;last&#160;in&#160;case&#160;you&#39;ve&#160;also&#160;got&#160;[link&#160;test][1]</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;or&#160;[link&#160;test](/foo)</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
<span style='color: #0099CC;'>//&#160;&#160;&#160;&#160;$text&#160;=&#160;preg_replace_callback(&#39;{</span><br/>
<span style='color: #0099CC;'>//&#160;&#160;&#160;&#160;&#160;&#160;(&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;wrap&#160;whole&#160;match&#160;in&#160;$1</span><br/>
<span style='color: #0099CC;'>//&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\[</span><br/>
<span style='color: #0099CC;'>//&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;([^\[\]]+)&#160;&#160;&#160;&#160;#&#160;link&#160;text&#160;=&#160;$2;&#160;can\&#39;t&#160;contain&#160;[&#160;or&#160;]</span><br/>
<span style='color: #0099CC;'>//&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\]</span><br/>
<span style='color: #0099CC;'>//&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #0099CC;'>//&#160;&#160;&#160;&#160;&#160;&#160;}xs&#39;,</span><br/>
<span style='color: #0099CC;'>//&#160;&#160;&#160;&#160;&#160;&#160;array(&#38;$this,&#160;&#39;_doAnchors_reference_callback&#39;),&#160;$text);</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;_doAnchors_reference_callback<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$whole_match</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$link_text</b></span>&#160;&#160;&#160;<span style='color: #0000FF;'>=</span>&#160;&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>2</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$link_id</b></span>&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#38;</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>3</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$link_id</b></span>&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#34;</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;for&#160;shortcut&#160;links&#160;like&#160;[this][]&#160;or&#160;[this].</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$link_id</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$link_text</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;lower-case&#160;and&#160;turn&#160;embedded&#160;newlines&#160;into&#160;spaces</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$link_id</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>strtolower</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$link_id</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$link_id</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;{[&#160;]?\n}&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;&#160;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$link_id</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #000099;'><b>isset</b></span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>urls<span style='color: #0000FF;'>[</span><span style='color: #990000;'><b>$link_id</b></span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$url</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>urls<span style='color: #0000FF;'>[</span><span style='color: #990000;'><b>$link_id</b></span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$url</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>encodeAmpsAndAngles<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$url</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$result</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#60;a&#160;href=\&#34;$url\&#34;&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span>&#160;<span style='color: #000099;'><b>isset</b></span><span style='color: #0000FF;'>(</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>titles<span style='color: #0000FF;'>[</span><span style='color: #990000;'><b>$link_id</b></span><span style='color: #0000FF;'>]</span>&#160;<span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$title</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>titles<span style='color: #0000FF;'>[</span><span style='color: #990000;'><b>$link_id</b></span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$title</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>encodeAmpsAndAngles<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$title</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$result</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;&#160;<span style='color: #008800;'>&#34;&#160;title=\&#34;$title\&#34;&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$link_text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>runSpanGamut<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$link_text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$result</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#62;$link_text&#60;/a&#62;&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$result</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>hashSpan<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$result</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>else</b></span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$result</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$whole_match</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$result</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;_doAnchors_inline_callback<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$whole_match</b></span>&#160;&#160;<span style='color: #0000FF;'>=</span>&#160;&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$link_text</b></span>&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>=</span>&#160;&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>runSpanGamut<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>2</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$url</b></span>&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>=</span>&#160;&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>3</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$title</b></span>&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#38;</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>6</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$url</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>encodeAmpsAndAngles<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$url</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$result</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#60;a&#160;href=\&#34;$url\&#34;&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #000099;'><b>isset</b></span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$title</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$title</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>str_replace</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;&#34;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;&#38;quot;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$title</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$title</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>encodeAmpsAndAngles<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$title</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$result</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;&#160;<span style='color: #008800;'>&#34;&#160;title=\&#34;$title\&#34;&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$link_text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>runSpanGamut<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$link_text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$result</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#62;$link_text&#60;/a&#62;&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>hashSpan<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$result</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;doImages<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Turn&#160;Markdown&#160;image&#160;shortcuts&#160;into&#160;&#60;img&#62;&#160;tags.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;First,&#160;handle&#160;reference-style&#160;labeled&#160;images:&#160;![alt&#160;text][id]</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace_callback</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;{</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;(&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;wrap&#160;whole&#160;match&#160;in&#160;$1</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;!\[</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>nested_brackets<span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;)&#160;&#160;&#160;&#160;#&#160;alt&#160;text&#160;=&#160;$2</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\]</span><br/>
<span style='color: #008800;'>&#160;</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#160;]?&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;one&#160;optional&#160;space</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?:\n[&#160;]*)?&#160;&#160;&#160;&#160;#&#160;one&#160;optional&#160;newline&#160;followed&#160;by&#160;spaces</span><br/>
<span style='color: #008800;'>&#160;</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\[</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(.*?)&#160;&#160;&#160;&#160;#&#160;id&#160;=&#160;$3</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\]</span><br/>
<span style='color: #008800;'>&#160;</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;}xs&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>&#38;</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;_doImages_reference_callback&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Next,&#160;handle&#160;inline&#160;images:&#160;&#160;![alt&#160;text](url&#160;&#34;optional&#160;title&#34;)</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Don&#39;t&#160;forget:&#160;encode&#160;*&#160;and&#160;_</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace_callback</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;{</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;(&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;wrap&#160;whole&#160;match&#160;in&#160;$1</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;!\[</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>nested_brackets<span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;)&#160;&#160;&#160;&#160;#&#160;alt&#160;text&#160;=&#160;$2</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\]</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\s?&#160;&#160;&#160;&#160;&#160;&#160;#&#160;One&#160;optional&#160;whitespace&#160;character</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\(&#160;&#160;&#160;&#160;&#160;&#160;#&#160;literal&#160;paren</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#160;\t]*</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#60;?(\S+?)&#62;?&#160;&#160;#&#160;src&#160;url&#160;=&#160;$3</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#160;\t]*</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(&#160;&#160;&#160;&#160;&#160;&#160;#&#160;$4</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;([\&#39;&#34;])&#160;&#160;#&#160;quote&#160;char&#160;=&#160;$5</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(.*?)&#160;&#160;&#160;&#160;#&#160;title&#160;=&#160;$6</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\5&#160;&#160;&#160;&#160;#&#160;matching&#160;quote</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#160;\t]*</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)?&#160;&#160;&#160;&#160;&#160;&#160;#&#160;title&#160;is&#160;optional</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;}xs&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>&#38;</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;_doImages_inline_callback&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;_doImages_reference_callback<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$whole_match</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$alt_text</b></span>&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>2</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$link_id</b></span>&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>strtolower</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>3</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$link_id</b></span>&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#34;</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$link_id</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>strtolower</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$alt_text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span>&#160;<span style='color: #0099CC;'>#&#160;for&#160;shortcut&#160;links&#160;like&#160;![this][].</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$alt_text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>str_replace</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;&#34;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;&#38;quot;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$alt_text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #000099;'><b>isset</b></span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>urls<span style='color: #0000FF;'>[</span><span style='color: #990000;'><b>$link_id</b></span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$url</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>urls<span style='color: #0000FF;'>[</span><span style='color: #990000;'><b>$link_id</b></span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$result</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#60;img&#160;src=\&#34;$url\&#34;&#160;alt=\&#34;$alt_text\&#34;&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #000099;'><b>isset</b></span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>titles<span style='color: #0000FF;'>[</span><span style='color: #990000;'><b>$link_id</b></span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$title</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>titles<span style='color: #0000FF;'>[</span><span style='color: #990000;'><b>$link_id</b></span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$result</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;&#160;<span style='color: #008800;'>&#34;&#160;title=\&#34;$title\&#34;&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$result</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>empty_element_suffix<span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$result</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>hashSpan<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$result</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>else</b></span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;If&#160;there&#39;s&#160;no&#160;such&#160;link&#160;ID,&#160;leave&#160;intact:</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$result</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$whole_match</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$result</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;_doImages_inline_callback<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$whole_match</b></span>&#160;&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$alt_text</b></span>&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>2</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$url</b></span>&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>3</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$title</b></span>&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#38;</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>6</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$alt_text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>str_replace</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;&#34;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;&#38;quot;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$alt_text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$result</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#60;img&#160;src=\&#34;$url\&#34;&#160;alt=\&#34;$alt_text\&#34;&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #000099;'><b>isset</b></span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$title</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$title</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>str_replace</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;&#34;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;&#38;quot;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$title</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$result</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;&#160;<span style='color: #008800;'>&#34;&#160;title=\&#34;$title\&#34;&#34;</span><span style='color: #0000FF;'>;</span>&#160;<span style='color: #0099CC;'>#&#160;$title&#160;already&#160;quoted</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$result</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>empty_element_suffix<span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>hashSpan<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$result</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;doHeaders<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Setext-style&#160;headers:</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;Header&#160;1</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;========</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;Header&#160;2</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;--------</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace_callback</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;{&#160;^(.+)[&#160;\t]*\n=+[&#160;\t]*\n+&#160;}mx&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>&#38;</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;_doHeaders_callback_setext_h1&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace_callback</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;{&#160;^(.+)[&#160;\t]*\n-+[&#160;\t]*\n+&#160;}mx&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>&#38;</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;_doHeaders_callback_setext_h2&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;atx-style&#160;headers:</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;#&#160;Header&#160;1</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;##&#160;Header&#160;2</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;##&#160;Header&#160;2&#160;with&#160;closing&#160;hashes&#160;##</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;...</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;######&#160;Header&#160;6</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace_callback</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;{</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;^(\#{1,6})&#160;&#160;#&#160;$1&#160;=&#160;string&#160;of&#160;#\&#39;s</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#160;\t]*</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(.+?)&#160;&#160;&#160;&#160;#&#160;$2&#160;=&#160;Header&#160;text</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#160;\t]*</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\#*&#160;&#160;&#160;&#160;&#160;&#160;#&#160;optional&#160;closing&#160;#\&#39;s&#160;(not&#160;counted)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\n+</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;}xm&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>&#38;</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;_doHeaders_callback_atx&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;_doHeaders_callback_setext_h1<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$block</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#60;h1&#62;&#34;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>runSpanGamut<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#34;&#60;/h1&#62;&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #008800;'>&#34;\n&#34;</span>&#160;<span style='color: #0000FF;'>.</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>hashBlock<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$block</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>.</span>&#160;<span style='color: #008800;'>&#34;\n\n&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;_doHeaders_callback_setext_h2<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$block</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#60;h2&#62;&#34;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>runSpanGamut<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#34;&#60;/h2&#62;&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #008800;'>&#34;\n&#34;</span>&#160;<span style='color: #0000FF;'>.</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>hashBlock<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$block</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>.</span>&#160;<span style='color: #008800;'>&#34;\n\n&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;_doHeaders_callback_atx<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$level</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>strlen</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$block</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#60;h$level&#62;&#34;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>runSpanGamut<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>2</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#34;&#60;/h$level&#62;&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #008800;'>&#34;\n&#34;</span>&#160;<span style='color: #0000FF;'>.</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>hashBlock<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$block</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>.</span>&#160;<span style='color: #008800;'>&#34;\n\n&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;doLists<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Form&#160;HTML&#160;ordered&#160;(numbered)&#160;and&#160;unordered&#160;(bulleted)&#160;lists.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$less_than_tab</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>tab_width&#160;<span style='color: #0000FF;'>-</span>&#160;<span style='color: purple;'>1</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Re-usable&#160;patterns&#160;to&#160;match&#160;list&#160;item&#160;bullets&#160;and&#160;number&#160;markers:</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$marker_ul</b></span>&#160;&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;[*+-]&#39;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$marker_ol</b></span>&#160;&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;\d+[.]&#39;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$marker_any</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;(?:$marker_ul|$marker_ol)&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$markers</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$marker_ul</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$marker_ol</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>foreach</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$markers</b></span>&#160;<span style='color: #000099;'><b>as</b></span>&#160;<span style='color: #990000;'><b>$marker</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Re-usable&#160;pattern&#160;to&#160;match&#160;any&#160;entirel&#160;ul&#160;or&#160;ol&#160;list:</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$whole_list</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;$1&#160;=&#160;whole&#160;list</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;$2</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#160;]{0,&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$less_than_tab</b></span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;}</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$marker</b></span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;)&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;$3&#160;=&#160;first&#160;list&#160;item&#160;marker</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#160;\t]+</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?s:.+?)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;$4</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\z</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;|</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\n{2,}</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?=\S)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?!&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;Negative&#160;lookahead&#160;for&#160;another&#160;list&#160;item&#160;marker</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#160;\t]*</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$marker</b></span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;[&#160;\t]+</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#39;</span><span style='color: #0000FF;'>;</span>&#160;<span style='color: #0099CC;'>//&#160;mx</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;We&#160;use&#160;a&#160;different&#160;prefix&#160;before&#160;nested&#160;lists&#160;than&#160;top-level&#160;lists.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;See&#160;extended&#160;comment&#160;in&#160;_ProcessListItems().</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>list_level<span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace_callback</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;{</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;^</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$whole_list</b></span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;}mx&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>&#38;</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;_doLists_callback&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>else</b></span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace_callback</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;{</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?:(?&#60;=\n)\n|\A\n?)&#160;#&#160;Must&#160;eat&#160;the&#160;newline</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$whole_list</b></span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;}mx&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>&#38;</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;_doLists_callback&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;_doLists_callback<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Re-usable&#160;patterns&#160;to&#160;match&#160;list&#160;item&#160;bullets&#160;and&#160;number&#160;markers:</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$marker_ul</b></span>&#160;&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;[*+-]&#39;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$marker_ol</b></span>&#160;&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;\d+[.]&#39;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$marker_any</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;(?:$marker_ul|$marker_ol)&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$list</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$list_type</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_match</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#34;/$marker_ul/&#34;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>3</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>?</span>&#160;<span style='color: #008800;'>&#34;ul&#34;</span>&#160;<span style='color: #0000FF;'>:</span>&#160;<span style='color: #008800;'>&#34;ol&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$marker_any</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #0000FF;'>(</span>&#160;<span style='color: #990000;'><b>$list_type</b></span>&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;ul&#34;</span>&#160;<span style='color: #0000FF;'>?</span>&#160;<span style='color: #990000;'><b>$marker_ul</b></span>&#160;<span style='color: #0000FF;'>:</span>&#160;<span style='color: #990000;'><b>$marker_ol</b></span>&#160;<span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$list</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;\n&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$result</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>processListItems<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$list</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$marker_any</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$result</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>hashBlock<span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#34;&#60;$list_type&#62;\n&#34;</span>&#160;<span style='color: #0000FF;'>.</span>&#160;<span style='color: #990000;'><b>$result</b></span>&#160;<span style='color: #0000FF;'>.</span>&#160;<span style='color: #008800;'>&#34;&#60;/$list_type&#62;&#34;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #008800;'>&#34;\n&#34;</span><span style='color: #0000FF;'>.</span>&#160;<span style='color: #990000;'><b>$result</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#34;\n\n&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>var</b></span>&#160;<span style='color: #990000;'><b>$list_level</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: purple;'>0</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;processListItems<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$list_str</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$marker_any</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;Process&#160;the&#160;contents&#160;of&#160;a&#160;single&#160;ordered&#160;or&#160;unordered&#160;list,&#160;splitting&#160;it</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;into&#160;individual&#160;list&#160;items.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;The&#160;$this-&#62;list_level&#160;global&#160;keeps&#160;track&#160;of&#160;when&#160;we&#39;re&#160;inside&#160;a&#160;list.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Each&#160;time&#160;we&#160;enter&#160;a&#160;list,&#160;we&#160;increment&#160;it;&#160;when&#160;we&#160;leave&#160;a&#160;list,</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;we&#160;decrement.&#160;If&#160;it&#39;s&#160;zero,&#160;we&#39;re&#160;not&#160;in&#160;a&#160;list&#160;anymore.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;We&#160;do&#160;this&#160;because&#160;when&#160;we&#39;re&#160;not&#160;inside&#160;a&#160;list,&#160;we&#160;want&#160;to&#160;treat</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;something&#160;like&#160;this:</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;I&#160;recommend&#160;upgrading&#160;to&#160;version</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;8.&#160;Oops,&#160;now&#160;this&#160;line&#160;is&#160;treated</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;as&#160;a&#160;sub-list.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;As&#160;a&#160;single&#160;paragraph,&#160;despite&#160;the&#160;fact&#160;that&#160;the&#160;second&#160;line&#160;starts</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;with&#160;a&#160;digit-period-space&#160;sequence.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Whereas&#160;when&#160;we&#39;re&#160;inside&#160;a&#160;list&#160;(or&#160;sub-list),&#160;that&#160;line&#160;will&#160;be</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;treated&#160;as&#160;the&#160;start&#160;of&#160;a&#160;sub-list.&#160;What&#160;a&#160;kludge,&#160;huh?&#160;This&#160;is</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;an&#160;aspect&#160;of&#160;Markdown&#39;s&#160;syntax&#160;that&#39;s&#160;hard&#160;to&#160;parse&#160;perfectly</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;without&#160;resorting&#160;to&#160;mind-reading.&#160;Perhaps&#160;the&#160;solution&#160;is&#160;to</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;change&#160;the&#160;syntax&#160;rules&#160;such&#160;that&#160;sub-lists&#160;must&#160;start&#160;with&#160;a</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;starting&#160;cardinal&#160;number;&#160;e.g.&#160;&#34;1.&#34;&#160;or&#160;&#34;a.&#34;.</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>list_level<span style='color: #0000FF;'>+</span><span style='color: #0000FF;'>+</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;trim&#160;trailing&#160;blank&#160;lines:</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$list_str</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#34;/\n{2,}\\z/&#34;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#34;\n&#34;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$list_str</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$list_str</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace_callback</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;{</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;(\n)?&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;leading&#160;line&#160;=&#160;$1</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;(^[&#160;\t]*)&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;leading&#160;whitespace&#160;=&#160;$2</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;(&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$marker_any</b></span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;)&#160;[&#160;\t]+&#160;&#160;&#160;&#160;#&#160;list&#160;marker&#160;=&#160;$3</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;((?s:.+?))&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;list&#160;item&#160;text&#160;&#160;&#160;=&#160;$4</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;(?:(\n+(?=\n))|\n)&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;tailing&#160;blank&#160;line&#160;=&#160;$5</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;(?=&#160;\n*&#160;(\z&#160;|&#160;\2&#160;(&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$marker_any</b></span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;)&#160;[&#160;\t]+))</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;}xm&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>&#38;</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;_processListItems_callback&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$list_str</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>list_level<span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$list_str</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;_processListItems_callback<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$item</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>4</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$leading_line</b></span>&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#38;</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$leading_space</b></span>&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#38;</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>2</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$tailing_blank_line</b></span>&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#38;</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>5</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$leading_line</b></span>&#160;<span style='color: #0000FF;'>|</span><span style='color: #0000FF;'>|</span>&#160;<span style='color: #990000;'><b>$tailing_blank_line</b></span>&#160;<span style='color: #0000FF;'>|</span><span style='color: #0000FF;'>|</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #ff0000;'>preg_match</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;/\n{2,}/&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$item</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$item</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>runBlockGamut<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>outdent<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$item</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#34;\n&#34;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>else</b></span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Recursion&#160;for&#160;sub-lists:</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$item</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>doLists<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>outdent<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$item</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$item</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;/\n+$/&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$item</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$item</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>runSpanGamut<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$item</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #008800;'>&#34;&#60;li&#62;&#34;</span>&#160;<span style='color: #0000FF;'>.</span>&#160;<span style='color: #990000;'><b>$item</b></span>&#160;<span style='color: #0000FF;'>.</span>&#160;<span style='color: #008800;'>&#34;&#60;/li&#62;\n&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;doCodeBlocks<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;Process&#160;Markdown&#160;`&#60;pre&#62;&#60;code&#62;`&#160;blocks.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace_callback</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;{</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?:\n\n|\A)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;$1&#160;=&#160;the&#160;code&#160;block&#160;--&#160;one&#160;or&#160;more&#160;lines,&#160;starting&#160;with&#160;a&#160;space/tab</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?:</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?:[&#160;]{&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>tab_width<span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;}&#160;|&#160;\t)&#160;&#160;#&#160;Lines&#160;must&#160;start&#160;with&#160;a&#160;tab&#160;or&#160;a&#160;tab-width&#160;of&#160;spaces</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;.*\n+</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)+</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;((?=^[&#160;]{0,&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>tab_width<span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;}\S)|\Z)&#160;&#160;#&#160;Lookahead&#160;for&#160;non-space&#160;at&#160;line-start,&#160;or&#160;end&#160;of&#160;doc</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;}xm&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>&#38;</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;_doCodeBlocks_callback&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;_doCodeBlocks_callback<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$codeblock</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$codeblock</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>encodeCode<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>outdent<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$codeblock</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0099CC;'>//&#160;&#160;$codeblock&#160;=&#160;$this-&#62;detab($codeblock);</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;trim&#160;leading&#160;newlines&#160;and&#160;trailing&#160;whitespace</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$codeblock</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace</span><span style='color: #0000FF;'>(</span><span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;/\A\n+/&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;/\n+\z/&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$codeblock</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$result</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;\n\n&#34;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>hashBlock<span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#34;&#60;pre&#62;&#60;code&#62;&#34;</span>&#160;<span style='color: #0000FF;'>.</span>&#160;<span style='color: #990000;'><b>$codeblock</b></span>&#160;<span style='color: #0000FF;'>.</span>&#160;<span style='color: #008800;'>&#34;\n&#60;/code&#62;&#60;/pre&#62;&#34;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#34;\n\n&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$result</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;doCodeSpans<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;*&#160;&#160;Backtick&#160;quotes&#160;are&#160;used&#160;for&#160;&#60;code&#62;&#60;/code&#62;&#160;spans.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;*&#160;&#160;You&#160;can&#160;use&#160;multiple&#160;backticks&#160;as&#160;the&#160;delimiters&#160;if&#160;you&#160;want&#160;to</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;&#160;include&#160;literal&#160;backticks&#160;in&#160;the&#160;code&#160;span.&#160;So,&#160;this&#160;input:</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;&#160;&#160;Just&#160;type&#160;``foo&#160;`bar`&#160;baz``&#160;at&#160;the&#160;prompt.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;&#160;&#160;Will&#160;translate&#160;to:</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;&#160;&#160;&#60;p&#62;Just&#160;type&#160;&#60;code&#62;foo&#160;`bar`&#160;baz&#60;/code&#62;&#160;at&#160;the&#160;prompt.&#60;/p&#62;</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;There&#39;s&#160;no&#160;arbitrary&#160;limit&#160;to&#160;the&#160;number&#160;of&#160;backticks&#160;you</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;can&#160;use&#160;as&#160;delimters.&#160;If&#160;you&#160;need&#160;three&#160;consecutive&#160;backticks</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;in&#160;your&#160;code,&#160;use&#160;four&#160;for&#160;delimiters,&#160;etc.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;*&#160;&#160;You&#160;can&#160;use&#160;spaces&#160;to&#160;get&#160;literal&#160;backticks&#160;at&#160;the&#160;edges:</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;&#160;&#160;...&#160;type&#160;``&#160;`bar`&#160;``&#160;...</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;&#160;&#160;Turns&#160;to:</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;&#160;&#160;...&#160;type&#160;&#60;code&#62;`bar`&#60;/code&#62;&#160;...</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace_callback</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;@</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?&#60;!\\\)&#160;&#160;#&#160;Character&#160;before&#160;opening&#160;`&#160;can\&#39;t&#160;be&#160;a&#160;backslash</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(`+)&#160;&#160;&#160;&#160;#&#160;$1&#160;=&#160;Opening&#160;run&#160;of&#160;`</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(.+?)&#160;&#160;&#160;&#160;#&#160;$2&#160;=&#160;The&#160;code&#160;block</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?&#60;!`)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\1&#160;&#160;&#160;&#160;&#160;&#160;#&#160;Matching&#160;closer</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?!`)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;@xs&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>&#38;</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;_doCodeSpans_callback&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;_doCodeSpans_callback<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$c</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>2</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$c</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;/^[&#160;\t]*/&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$c</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span>&#160;<span style='color: #0099CC;'>#&#160;leading&#160;whitespace</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$c</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;/[&#160;\t]*$/&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$c</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span>&#160;<span style='color: #0099CC;'>#&#160;trailing&#160;whitespace</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$c</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>encodeCode<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$c</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>hashSpan<span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#34;&#60;code&#62;$c&#60;/code&#62;&#34;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;encodeCode<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$_</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Encode/escape&#160;certain&#160;characters&#160;inside&#160;Markdown&#160;code&#160;runs.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;The&#160;point&#160;is&#160;that&#160;in&#160;code,&#160;these&#160;characters&#160;are&#160;literals,</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;and&#160;lose&#160;their&#160;special&#160;Markdown&#160;meanings.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Encode&#160;all&#160;ampersands;&#160;HTML&#160;entities&#160;are&#160;not</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;entities&#160;within&#160;a&#160;Markdown&#160;code&#160;span.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$_</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>str_replace</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;&#38;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;&#38;amp;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$_</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Do&#160;the&#160;angle&#160;bracket&#160;song&#160;and&#160;dance:</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$_</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>str_replace</span><span style='color: #0000FF;'>(</span><span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;&#60;&#39;</span><span style='color: #0000FF;'>,</span>&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#39;&#62;&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;&#38;lt;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;&#38;gt;&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$_</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Now,&#160;escape&#160;characters&#160;that&#160;are&#160;magic&#160;in&#160;Markdown:</span><br/>
<span style='color: #0099CC;'>//&#160;&#160;&#160;&#160;$_&#160;=&#160;str_replace(array_keys($this-&#62;escape_table),</span><br/>
<span style='color: #0099CC;'>//&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;array_values($this-&#62;escape_table),&#160;$_);</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$_</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;doItalicsAndBold<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#60;strong&#62;&#160;must&#160;go&#160;first:</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace_callback</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;{</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;$1:&#160;Marker</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?&#60;!\*\*)&#160;\*&#160;|&#160;&#160;&#160;&#160;#&#160;&#160;&#160;&#160;&#160;(not&#160;preceded&#160;by&#160;two&#160;chars&#160;of</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?&#60;!__)&#160;&#160;&#160;_&#160;&#160;&#160;&#160;&#160;&#160;#&#160;&#160;&#160;&#160;&#160;&#160;the&#160;same&#160;marker)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\1</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?=\S)&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;Not&#160;followed&#160;by&#160;whitespace</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?!\1\1)&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;&#160;&#160;or&#160;two&#160;others&#160;marker&#160;chars.</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;$2:&#160;Content</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?:</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[^*_]+?&#160;&#160;&#160;&#160;&#160;&#160;#&#160;Anthing&#160;not&#160;em&#160;markers.</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;|</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;Balence&#160;any&#160;regular&#160;emphasis&#160;inside.</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\1&#160;(?=\S)&#160;.+?&#160;(?&#60;=\S)&#160;\1</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;|</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?!&#160;\1&#160;)&#160;.&#160;&#160;&#160;&#160;#&#160;Allow&#160;unbalenced&#160;*&#160;and&#160;_.</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)+?</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?&#60;=\S)&#160;\1\1&#160;&#160;&#160;&#160;&#160;&#160;#&#160;End&#160;mark&#160;not&#160;preceded&#160;by&#160;whitespace.</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;}sx&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>&#38;</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;_doItalicAndBold_strong_callback&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Then&#160;&#60;em&#62;:</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace_callback</span><span style='color: #0000FF;'>(</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#39;{&#160;(&#160;(?&#60;!\*)\*&#160;|&#160;(?&#60;!_)_&#160;)&#160;(?=\S)&#160;(?!&#160;\1)&#160;(.+?)&#160;(?&#60;=\S)&#160;\1&#160;}sx&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>&#38;</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;_doItalicAndBold_em_callback&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;_doItalicAndBold_em_callback<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>2</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>runSpanGamut<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>hashSpan<span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#34;&#60;em&#62;$text&#60;/em&#62;&#34;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;_doItalicAndBold_strong_callback<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>2</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>runSpanGamut<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>hashSpan<span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#34;&#60;strong&#62;$text&#60;/strong&#62;&#34;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;doBlockQuotes<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace_callback</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;/</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;Wrap&#160;whole&#160;match&#160;in&#160;$1</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;^[&#160;\t]*&#62;[&#160;\t]?&#160;&#160;&#160;&#160;&#160;&#160;#&#160;&#34;&#62;&#34;&#160;at&#160;the&#160;start&#160;of&#160;a&#160;line</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;.+\n&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;rest&#160;of&#160;the&#160;first&#160;line</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(.+\n)*&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;subsequent&#160;consecutive&#160;lines</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\n*&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;blanks</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)+</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;/xm&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>&#38;</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;_doBlockQuotes_callback&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;_doBlockQuotes_callback<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$bq</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;trim&#160;one&#160;level&#160;of&#160;quoting&#160;-&#160;trim&#160;whitespace-only&#160;lines</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$bq</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace</span><span style='color: #0000FF;'>(</span><span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;/^[&#160;\t]*&#62;[&#160;\t]?/m&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;/^[&#160;\t]+$/m&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$bq</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$bq</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>runBlockGamut<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$bq</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span>&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;recurse</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$bq</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;/^/m&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#34;&#160;&#160;&#34;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$bq</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;These&#160;leading&#160;spaces&#160;cause&#160;problem&#160;with&#160;&#60;pre&#62;&#160;content,</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;so&#160;we&#160;need&#160;to&#160;fix&#160;that:</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$bq</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace_callback</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;{(\s*&#60;pre&#62;.+?&#60;/pre&#62;)}sx&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>&#38;</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;_DoBlockQuotes_callback2&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$bq</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #008800;'>&#34;\n&#34;</span><span style='color: #0000FF;'>.</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>hashBlock<span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#34;&#60;blockquote&#62;\n$bq\n&#60;/blockquote&#62;&#34;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#34;\n\n&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;_doBlockQuotes_callback2<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$pre</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$pre</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;/^&#160;&#160;/m&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$pre</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$pre</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;formParagraphs<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;Params:</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;$text&#160;-&#160;string&#160;to&#160;process&#160;with&#160;html&#160;&#60;p&#62;&#160;tags</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Strip&#160;leading&#160;and&#160;trailing&#160;lines:</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace</span><span style='color: #0000FF;'>(</span><span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;/\A\n+/&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;/\n+\z/&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$grafs</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_split</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;/\n{2,}/&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #0000FF;'>-</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>,</span>&#160;PREG_SPLIT_NO_EMPTY<span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Wrap&#160;&#60;p&#62;&#160;tags.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>foreach</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$grafs</b></span>&#160;<span style='color: #000099;'><b>as</b></span>&#160;<span style='color: #990000;'><b>$key</b></span>&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: #990000;'><b>$value</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>!</span><span style='color: #000099;'><b>isset</b></span><span style='color: #0000FF;'>(</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>html_blocks<span style='color: #0000FF;'>[</span><span style='color: #990000;'><b>$value</b></span><span style='color: #0000FF;'>]</span>&#160;<span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$value</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>runSpanGamut<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$value</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$value</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;/^([&#160;\t]*)/&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#34;&#60;p&#62;&#34;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$value</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$value</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#60;/p&#62;&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$grafs</b></span><span style='color: #0000FF;'>[</span><span style='color: #990000;'><b>$key</b></span><span style='color: #0000FF;'>]</span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>unhash<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$value</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Unhashify&#160;HTML&#160;blocks</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>foreach</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$grafs</b></span>&#160;<span style='color: #000099;'><b>as</b></span>&#160;<span style='color: #990000;'><b>$key</b></span>&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: #990000;'><b>$graf</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Modify&#160;elements&#160;of&#160;@grafs&#160;in-place...</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #000099;'><b>isset</b></span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>html_blocks<span style='color: #0000FF;'>[</span><span style='color: #990000;'><b>$graf</b></span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$block</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>html_blocks<span style='color: #0000FF;'>[</span><span style='color: #990000;'><b>$graf</b></span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$graf</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$block</b></span><span style='color: #0000FF;'>;</span><br/>
<span style='color: #0099CC;'>//&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;if&#160;(preg_match(&#39;{</span><br/>
<span style='color: #0099CC;'>//&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\A</span><br/>
<span style='color: #0099CC;'>//&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;$1&#160;=&#160;&#60;div&#62;&#160;tag</span><br/>
<span style='color: #0099CC;'>//&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#60;div&#160;&#160;\s+</span><br/>
<span style='color: #0099CC;'>//&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[^&#62;]*</span><br/>
<span style='color: #0099CC;'>//&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\b</span><br/>
<span style='color: #0099CC;'>//&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;markdown\s*=\s*&#160;&#160;([\&#39;&#34;])&#160;&#160;#&#160;&#160;$2&#160;=&#160;attr&#160;quote&#160;char</span><br/>
<span style='color: #0099CC;'>//&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;1</span><br/>
<span style='color: #0099CC;'>//&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\2</span><br/>
<span style='color: #0099CC;'>//&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[^&#62;]*</span><br/>
<span style='color: #0099CC;'>//&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#62;</span><br/>
<span style='color: #0099CC;'>//&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #0099CC;'>//&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;$3&#160;=&#160;contents</span><br/>
<span style='color: #0099CC;'>//&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;.*</span><br/>
<span style='color: #0099CC;'>//&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #0099CC;'>//&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(&#60;/div&#62;)&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;$4&#160;=&#160;closing&#160;tag</span><br/>
<span style='color: #0099CC;'>//&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\z</span><br/>
<span style='color: #0099CC;'>//&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;}xs&#39;,&#160;$block,&#160;$matches))</span><br/>
<span style='color: #0099CC;'>//&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;{</span><br/>
<span style='color: #0099CC;'>//&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;list(,&#160;$div_open,&#160;,&#160;$div_content,&#160;$div_close)&#160;=&#160;$matches;</span><br/>
<span style='color: #0099CC;'>//</span><br/>
<span style='color: #0099CC;'>//&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;We&#160;can&#39;t&#160;call&#160;Markdown(),&#160;because&#160;that&#160;resets&#160;the&#160;hash;</span><br/>
<span style='color: #0099CC;'>//&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;that&#160;initialization&#160;code&#160;should&#160;be&#160;pulled&#160;into&#160;its&#160;own&#160;sub,&#160;though.</span><br/>
<span style='color: #0099CC;'>//&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;$div_content&#160;=&#160;$this-&#62;hashHTMLBlocks($div_content);</span><br/>
<span style='color: #0099CC;'>//</span><br/>
<span style='color: #0099CC;'>//&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;Run&#160;document&#160;gamut&#160;methods&#160;on&#160;the&#160;content.</span><br/>
<span style='color: #0099CC;'>//&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;foreach&#160;($this-&#62;document_gamut&#160;as&#160;$method&#160;=&#62;&#160;$priority)&#160;{</span><br/>
<span style='color: #0099CC;'>//&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;$div_content&#160;=&#160;$this-&#62;$method($div_content);</span><br/>
<span style='color: #0099CC;'>//&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;}</span><br/>
<span style='color: #0099CC;'>//</span><br/>
<span style='color: #0099CC;'>//&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;$div_open&#160;=&#160;preg_replace(</span><br/>
<span style='color: #0099CC;'>//&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#39;{\smarkdown\s*=\s*([\&#39;&#34;]).+?\1}&#39;,&#160;&#39;&#39;,&#160;$div_open);</span><br/>
<span style='color: #0099CC;'>//</span><br/>
<span style='color: #0099CC;'>//&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;$graf&#160;=&#160;$div_open&#160;.&#160;&#34;\n&#34;&#160;.&#160;$div_content&#160;.&#160;&#34;\n&#34;&#160;.&#160;$div_close;</span><br/>
<span style='color: #0099CC;'>//&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;}</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$grafs</b></span><span style='color: #0000FF;'>[</span><span style='color: #990000;'><b>$key</b></span><span style='color: #0000FF;'>]</span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$graf</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #ff0000;'>implode</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#34;\n\n&#34;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$grafs</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;encodeAmpsAndAngles<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Smart&#160;processing&#160;for&#160;ampersands&#160;and&#160;angle&#160;brackets&#160;that&#160;need&#160;to&#160;be&#160;encoded.</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Ampersand-encoding&#160;based&#160;entirely&#160;on&#160;Nat&#160;Irons&#39;s&#160;Amputator&#160;MT&#160;plugin:</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;http://bumppo.net/projects/amputator/</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;/&#38;(?!#?[xX]?(?:[0-9a-fA-F]+|\w+);)/&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#39;&#38;amp;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Encode&#160;naked&#160;&#60;&#39;s</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;{&#60;(?![a-z/?\$!%])}i&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;&#38;lt;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;encodeBackslashEscapes<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;Parameter:&#160;&#160;String.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;Returns:&#160;&#160;&#160;&#160;The&#160;string,&#160;with&#160;after&#160;processing&#160;the&#160;following&#160;backslash</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;escape&#160;sequences.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Must&#160;process&#160;escaped&#160;backslashes&#160;first.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #ff0000;'>str_replace</span><span style='color: #0000FF;'>(</span><span style='color: #ff0000;'>array_keys</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>backslash_escape_table<span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #ff0000;'>array_values</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>backslash_escape_table<span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;doAutoLinks<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace_callback</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;{&#60;((https?|ftp|dict):[^\&#39;&#34;&#62;\s]+)&#62;}&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>&#38;</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;_doAutoLinks_url_callback&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Email&#160;addresses:&#160;&#60;address@domain.foo&#62;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace_callback</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;{</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#60;</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;(?:mailto:)?</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;(</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[-.\w\x80-\xFF]+</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\@</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[-a-z0-9\x80-\xFF]+(\.[-a-z0-9\x80-\xFF]+)*\.[a-z]+</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#62;</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;}xi&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>&#38;</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;_doAutoLinks_email_callback&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;_doAutoLinks_url_callback<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$url</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>encodeAmpsAndAngles<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$link</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#60;a&#160;href=\&#34;$url\&#34;&#62;$url&#60;/a&#62;&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>hashSpan<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$link</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;_doAutoLinks_email_callback<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$address</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$address</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>unescapeSpecialChars<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$address</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$link</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>encodeEmailAddress<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$address</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>hashSpan<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$link</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;encodeEmailAddress<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$addr</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;Input:&#160;an&#160;email&#160;address,&#160;e.g.&#160;&#34;foo@example.com&#34;</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;Output:&#160;the&#160;email&#160;address&#160;as&#160;a&#160;mailto&#160;link,&#160;with&#160;each&#160;character</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;of&#160;the&#160;address&#160;encoded&#160;as&#160;either&#160;a&#160;decimal&#160;or&#160;hex&#160;entity,&#160;in</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;the&#160;hopes&#160;of&#160;foiling&#160;most&#160;address&#160;harvesting&#160;spam&#160;bots.&#160;E.g.:</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;&#60;p&#62;&#60;a&#160;href=&#34;&#38;#109;&#38;#x61;&#38;#105;&#38;#x6c;&#38;#116;&#38;#x6f;&#38;#58;&#38;#x66;o&#38;#111;</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#38;#x40;&#38;#101;&#38;#x78;&#38;#97;&#38;#x6d;&#38;#112;&#38;#x6c;&#38;#101;&#38;#46;&#38;#x63;&#38;#111;</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#38;#x6d;&#34;&#62;&#38;#x66;o&#38;#111;&#38;#x40;&#38;#101;&#38;#x78;&#38;#97;&#38;#x6d;&#38;#112;&#38;#x6c;</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#38;#101;&#38;#46;&#38;#x63;&#38;#111;&#38;#x6d;&#60;/a&#62;&#60;/p&#62;</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;Based&#160;by&#160;a&#160;filter&#160;by&#160;Matthew&#160;Wickline,&#160;posted&#160;to&#160;BBEdit-Talk.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;With&#160;some&#160;optimizations&#160;by&#160;Milian&#160;Wolff.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$addr</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;mailto:&#34;</span>&#160;<span style='color: #0000FF;'>.</span>&#160;<span style='color: #990000;'><b>$addr</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$chars</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_split</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;/(?&#60;!^)(?!$)/&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$addr</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$seed</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #000099;'><b>int</b></span><span style='color: #0000FF;'>)</span><span style='color: #ff0000;'>abs</span><span style='color: #0000FF;'>(</span><span style='color: #ff0000;'>crc32</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$addr</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>/</span>&#160;<span style='color: #ff0000;'>strlen</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$addr</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span>&#160;<span style='color: #0099CC;'>#&#160;Deterministic&#160;seed.</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>foreach</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$chars</b></span>&#160;<span style='color: #000099;'><b>as</b></span>&#160;<span style='color: #990000;'><b>$key</b></span>&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: #990000;'><b>$char</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$ord</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>ord</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$char</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Ignore&#160;non-ascii&#160;chars.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$ord</b></span>&#160;<span style='color: #0000FF;'>&#60;</span>&#160;<span style='color: purple;'>128</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$r</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$seed</b></span>&#160;<span style='color: #0000FF;'>*</span>&#160;<span style='color: #0000FF;'>(</span><span style='color: purple;'>1</span>&#160;<span style='color: #0000FF;'>+</span>&#160;<span style='color: #990000;'><b>$key</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>%</span>&#160;<span style='color: purple;'>100</span><span style='color: #0000FF;'>;</span>&#160;<span style='color: #0099CC;'>#&#160;Pseudo-random&#160;function.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;roughly&#160;10%&#160;raw,&#160;45%&#160;hex,&#160;45%&#160;dec</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#39;@&#39;&#160;*must*&#160;be&#160;encoded.&#160;I&#160;insist.</span><br/>
<span style='color: #0099CC;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#60;span style=&#39;color: #000099;&#39;&#62;&#60;b&#62;if&#60;/b&#62;&#60;/span&#62;&#160;&#60;span style=&#39;color: #0000FF;&#39;&#62;(&#60;/span&#62;&#60;span style=&#39;color: #990000;&#39;&#62;&#60;b&#62;$r&#60;/b&#62;&#60;/span&#62;&#160;&#60;span style=&#39;color: #0000FF;&#39;&#62;&#38;#62;&#60;/span&#62;&#160;&#60;span style=&#39;color: purple;&#39;&#62;90&#60;/span&#62;&#160;&#60;span style=&#39;color: #0000FF;&#39;&#62;&#38;#38;&#60;/span&#62;&#60;span style=&#39;color: #0000FF;&#39;&#62;&#38;#38;&#60;/span&#62;&#160;&#60;span style=&#39;color: #990000;&#39;&#62;&#60;b&#62;$char&#60;/b&#62;&#60;/span&#62;&#160;&#60;span style=&#39;color: #0000FF;&#39;&#62;!&#60;/span&#62;&#60;span style=&#39;color: #0000FF;&#39;&#62;=&#60;/span&#62;&#160;&#60;span style=&#39;color: #008800;&#39;&#62;&#38;#39;@&#38;#39;&#60;/span&#62;&#60;span style=&#39;color: #0000FF;&#39;&#62;)&#60;/span&#62;&#160;/*&#160;do&#160;nothing&#160;*/</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>else</b></span>&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$r</b></span>&#160;<span style='color: #0000FF;'>&#60;</span>&#160;<span style='color: purple;'>45</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #990000;'><b>$chars</b></span><span style='color: #0000FF;'>[</span><span style='color: #990000;'><b>$key</b></span><span style='color: #0000FF;'>]</span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;&#38;#x&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #ff0000;'>dechex</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$ord</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;;&#39;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>else</b></span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$chars</b></span><span style='color: #0000FF;'>[</span><span style='color: #990000;'><b>$key</b></span><span style='color: #0000FF;'>]</span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;&#38;#&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$ord</b></span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;;&#39;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$addr</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>implode</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$chars</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>implode</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #ff0000;'>array_slice</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$chars</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: purple;'>7</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span>&#160;<span style='color: #0099CC;'>#&#160;text&#160;without&#160;`mailto:`</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$addr</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#60;a&#160;href=\&#34;$addr\&#34;&#62;$text&#60;/a&#62;&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$addr</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;unescapeSpecialChars<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Swap&#160;back&#160;in&#160;all&#160;the&#160;special&#160;characters&#160;we&#39;ve&#160;hidden.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #ff0000;'>str_replace</span><span style='color: #0000FF;'>(</span><span style='color: #ff0000;'>array_values</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>escape_table<span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #ff0000;'>array_keys</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>escape_table<span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;tokenizeHTML<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$str</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;Parameter:&#160;&#160;String&#160;containing&#160;HTML&#160;+&#160;Markdown&#160;markup.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;Returns:&#160;&#160;&#160;&#160;An&#160;array&#160;of&#160;the&#160;tokens&#160;comprising&#160;the&#160;input</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;string.&#160;Each&#160;token&#160;is&#160;either&#160;a&#160;tag&#160;or&#160;a&#160;run&#160;of&#160;text</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;between&#160;tags.&#160;Each&#160;element&#160;of&#160;the&#160;array&#160;is&#160;a</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;two-element&#160;array;&#160;the&#160;first&#160;is&#160;either&#160;&#39;tag&#39;&#160;or&#160;&#39;text&#39;;</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;the&#160;second&#160;is&#160;the&#160;actual&#160;value.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;Note:&#160;&#160;&#160;&#160;&#160;&#160;&#160;Markdown&#160;code&#160;spans&#160;are&#160;taken&#160;into&#160;account:&#160;no&#160;tag&#160;token&#160;is</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;generated&#160;within&#160;a&#160;code&#160;span.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$tokens</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>while</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$str</b></span>&#160;<span style='color: #0000FF;'>!</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#34;</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Each&#160;loop&#160;iteration&#160;seach&#160;for&#160;either&#160;the&#160;next&#160;tag&#160;or&#160;the&#160;next</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;openning&#160;code&#160;span&#160;marker.&#160;If&#160;a&#160;code&#160;span&#160;marker&#160;is&#160;found,&#160;the</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;code&#160;span&#160;is&#160;extracted&#160;in&#160;entierty&#160;and&#160;will&#160;result&#160;in&#160;an&#160;extra</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;text&#160;token.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$parts</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_split</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;{</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?&#60;![`\\\\])</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;`+&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;code&#160;span&#160;marker</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;|</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#60;!--&#160;&#160;&#160;&#160;.*?&#160;&#160;&#160;&#160;&#160;--&#62;&#160;&#160;&#160;&#160;#&#160;comment</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;|</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#60;\?.*?\?&#62;&#160;|&#160;&#60;%.*?%&#62;&#160;&#160;&#160;&#160;#&#160;processing&#160;instruction</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;|</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#60;[/!$]?[-a-zA-Z0-9:]+&#160;&#160;#&#160;regular&#160;tags</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?:</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\s</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?&#62;[^&#34;\&#39;&#62;]+|&#34;[^&#34;]*&#34;|\&#39;[^\&#39;]*\&#39;)*</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)?</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#62;</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;}xs&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$str</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: purple;'>2</span><span style='color: #0000FF;'>,</span>&#160;PREG_SPLIT_DELIM_CAPTURE<span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Create&#160;token&#160;from&#160;text&#160;preceding&#160;tag.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$parts</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>0</span><span style='color: #0000FF;'>]</span>&#160;<span style='color: #0000FF;'>!</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#34;</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$tokens</b></span><span style='color: #0000FF;'>[</span><span style='color: #0000FF;'>]</span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;text&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$parts</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>0</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Check&#160;if&#160;we&#160;reach&#160;the&#160;end.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #ff0000;'>count</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$parts</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>&#60;</span>&#160;<span style='color: purple;'>3</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>break</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Create&#160;token&#160;from&#160;tag&#160;or&#160;code&#160;span.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$parts</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>{</span><span style='color: purple;'>0</span><span style='color: #0000FF;'>}</span>&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;`&#34;</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$tokens</b></span><span style='color: #0000FF;'>[</span><span style='color: #0000FF;'>]</span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;text&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$parts</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$str</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$parts</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>2</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Skip&#160;the&#160;whole&#160;code&#160;span,&#160;pass&#160;as&#160;text&#160;token.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #ff0000;'>preg_match</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;/^(.*(?&#60;!`\\\\)&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$parts</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;(?!`))(.*)$/sm&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$str</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$tokens</b></span><span style='color: #0000FF;'>[</span><span style='color: #0000FF;'>]</span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;text&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$str</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>2</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span>&#160;<span style='color: #000099;'><b>else</b></span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$tokens</b></span><span style='color: #0000FF;'>[</span><span style='color: #0000FF;'>]</span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;tag&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$parts</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$str</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$parts</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>2</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$tokens</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;outdent<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Remove&#160;one&#160;level&#160;of&#160;line-leading&#160;tabs&#160;or&#160;spaces</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #ff0000;'>preg_replace</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#34;/^(\\t|[&#160;]{1,$this-&#62;tab_width})/m&#34;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#34;&#34;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;String&#160;length&#160;function&#160;for&#160;detab.&#160;`_initDetab`&#160;will&#160;create&#160;a&#160;function&#160;to</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;hanlde&#160;UTF-8&#160;if&#160;the&#160;default&#160;function&#160;does&#160;not&#160;exist.</span><br/>
&#160;&#160;<span style='color: #000099;'><b>var</b></span>&#160;<span style='color: #990000;'><b>$utf8_strlen</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;mb_strlen&#39;</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;detab<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Replace&#160;tabs&#160;with&#160;the&#160;appropriate&#160;amount&#160;of&#160;space.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;For&#160;each&#160;line&#160;we&#160;separate&#160;the&#160;line&#160;in&#160;blocks&#160;delemited&#160;by</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;tab&#160;characters.&#160;Then&#160;we&#160;reconstruct&#160;every&#160;line&#160;by&#160;adding&#160;the</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;appropriate&#160;number&#160;of&#160;space&#160;between&#160;each&#160;blocks.</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$strlen</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>utf8_strlen<span style='color: #0000FF;'>;</span>&#160;<span style='color: #0099CC;'>#&#160;best&#160;strlen&#160;function&#160;for&#160;UTF-8.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$lines</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>explode</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#34;\n&#34;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>foreach</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$lines</b></span>&#160;<span style='color: #000099;'><b>as</b></span>&#160;<span style='color: #990000;'><b>$line</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Split&#160;in&#160;blocks.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$blocks</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>explode</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#34;\t&#34;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$line</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Add&#160;each&#160;blocks&#160;to&#160;the&#160;line.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$line</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$blocks</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>0</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #ff0000;'>unset</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$blocks</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>0</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span>&#160;<span style='color: #0099CC;'>#&#160;Do&#160;not&#160;add&#160;first&#160;block&#160;twice.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>foreach</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$blocks</b></span>&#160;<span style='color: #000099;'><b>as</b></span>&#160;<span style='color: #990000;'><b>$block</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Calculate&#160;amount&#160;of&#160;space,&#160;insert&#160;spaces,&#160;insert&#160;block.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$amount</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>tab_width&#160;<span style='color: #0000FF;'>-</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$strlen</b></span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$line</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;UTF-8&#39;</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>%</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>tab_width<span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$line</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>str_repeat</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#34;&#160;&#34;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$amount</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>.</span>&#160;<span style='color: #990000;'><b>$block</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;$line\n&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;_initDetab<span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Check&#160;for&#160;the&#160;availability&#160;of&#160;the&#160;function&#160;in&#160;the&#160;`utf8_strlen`&#160;property</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;(probably&#160;`mb_strlen`).&#160;If&#160;the&#160;function&#160;is&#160;not&#160;available,&#160;create&#160;a</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;function&#160;that&#160;will&#160;loosely&#160;count&#160;the&#160;number&#160;of&#160;UTF-8&#160;characters&#160;with&#160;a</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;regular&#160;expression.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #ff0000;'>function_exists</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>utf8_strlen<span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #000099;'><b>return</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>utf8_strlen&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;Markdown_UTF8_strlen&#39;</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #ff0000;'>function_exists</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>utf8_strlen<span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #000099;'><b>return</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;Markdown_UTF8_strlen<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #ff0000;'>preg_match_all</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;/[\x00-\xBF]|[\xC0-\xFF][\x80-\xBF]*/&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$m</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;unhash<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Swap&#160;back&#160;in&#160;all&#160;the&#160;tags&#160;hashed&#160;by&#160;_HashHTMLBlocks.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #ff0000;'>str_replace</span><span style='color: #0000FF;'>(</span><span style='color: #ff0000;'>array_keys</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>html_hashes<span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #ff0000;'>array_values</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>html_hashes<span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
<span style='color: #0099CC;'>#</span><br/>
<span style='color: #0099CC;'>#&#160;Markdown&#160;Extra&#160;Parser&#160;Class</span><br/>
<span style='color: #0099CC;'>#</span><br/>
&#160;<br/>
<span style='color: #000099;'><b>class</b></span>&#160;MarkdownExtra_Parser&#160;<span style='color: #000099;'><b>extends</b></span>&#160;Markdown_Parser&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;<br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Prefix&#160;for&#160;footnote&#160;ids.</span><br/>
&#160;&#160;<span style='color: #000099;'><b>var</b></span>&#160;<span style='color: #990000;'><b>$fn_id_prefix</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Optional&#160;title&#160;attribute&#160;for&#160;footnote&#160;links&#160;and&#160;backlinks.</span><br/>
&#160;&#160;<span style='color: #000099;'><b>var</b></span>&#160;<span style='color: #990000;'><b>$fn_link_title</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;MARKDOWN_FN_LINK_TITLE<span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #000099;'><b>var</b></span>&#160;<span style='color: #990000;'><b>$fn_backlink_title</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;MARKDOWN_FN_BACKLINK_TITLE<span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Optional&#160;class&#160;attribute&#160;for&#160;footnote&#160;links&#160;and&#160;backlinks.</span><br/>
&#160;&#160;<span style='color: #000099;'><b>var</b></span>&#160;<span style='color: #990000;'><b>$fn_link_class</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;MARKDOWN_FN_LINK_CLASS<span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #000099;'><b>var</b></span>&#160;<span style='color: #990000;'><b>$fn_backlink_class</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;MARKDOWN_FN_BACKLINK_CLASS<span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;MarkdownExtra_Parser<span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Constructor&#160;function.&#160;Initialize&#160;the&#160;parser&#160;object.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Add&#160;extra&#160;escapable&#160;characters&#160;before&#160;parent&#160;constructor</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;initialize&#160;the&#160;table.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>escape_chars&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;:|&#39;</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Insert&#160;extra&#160;document,&#160;block,&#160;and&#160;span&#160;transformations.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Parent&#160;constructor&#160;will&#160;do&#160;the&#160;sorting.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>document_gamut&#160;<span style='color: #0000FF;'>+</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#34;stripFootnotes&#34;</span>&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: purple;'>15</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#34;stripAbbreviations&#34;</span>&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: purple;'>25</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#34;appendFootnotes&#34;</span>&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: purple;'>50</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>block_gamut&#160;<span style='color: #0000FF;'>+</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#34;doTables&#34;</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: purple;'>15</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#34;doDefLists&#34;</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: purple;'>45</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>span_gamut&#160;<span style='color: #0000FF;'>+</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#34;doFootnotes&#34;</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;&#160;<span style='color: purple;'>4</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#34;doAbbreviations&#34;</span>&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;&#160;<span style='color: purple;'>5</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>parent</b></span><span style='color: #0000FF;'>:</span><span style='color: #0000FF;'>:</span>Markdown_Parser<span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Extra&#160;hashes&#160;used&#160;during&#160;extra&#160;transformations.</span><br/>
&#160;&#160;<span style='color: #000099;'><b>var</b></span>&#160;<span style='color: #990000;'><b>$footnotes</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #000099;'><b>var</b></span>&#160;<span style='color: #990000;'><b>$footnotes_ordered</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #000099;'><b>var</b></span>&#160;<span style='color: #990000;'><b>$abbr_desciptions</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #000099;'><b>var</b></span>&#160;<span style='color: #990000;'><b>$abbr_matches</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #000099;'><b>var</b></span>&#160;<span style='color: #990000;'><b>$html_cleans</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;transform<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Added&#160;clear&#160;to&#160;the&#160;new&#160;$html_hashes,&#160;reordered&#160;`hashHTMLBlocks`&#160;before</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;blank&#160;line&#160;stripping&#160;and&#160;added&#160;extra&#160;parameter&#160;to&#160;`runBlockGamut`.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Clear&#160;the&#160;global&#160;hashes.&#160;If&#160;we&#160;don&#39;t&#160;clear&#160;these,&#160;you&#160;get&#160;conflicts</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;from&#160;other&#160;articles&#160;when&#160;generating&#160;a&#160;page&#160;which&#160;contains&#160;more&#160;than</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;one&#160;article&#160;(e.g.&#160;an&#160;index&#160;page&#160;that&#160;shows&#160;the&#160;N&#160;most&#160;recent</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;articles):</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>footnotes&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>footnotes_ordered&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>abbr_desciptions&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>abbr_matches&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>html_cleans&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #000099;'><b>parent</b></span><span style='color: #0000FF;'>:</span><span style='color: #0000FF;'>:</span>transform<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #0099CC;'>###&#160;HTML&#160;Block&#160;Parser&#160;###</span><br/>
&#160;<br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Tags&#160;that&#160;are&#160;always&#160;treated&#160;as&#160;block&#160;tags:</span><br/>
&#160;&#160;<span style='color: #000099;'><b>var</b></span>&#160;<span style='color: #990000;'><b>$block_tags</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|address|form|fieldset|iframe|hr|legend&#39;</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Tags&#160;treated&#160;as&#160;block&#160;tags&#160;only&#160;if&#160;the&#160;opening&#160;tag&#160;is&#160;alone&#160;on&#160;it&#39;s&#160;line:</span><br/>
&#160;&#160;<span style='color: #000099;'><b>var</b></span>&#160;<span style='color: #990000;'><b>$context_block_tags</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;script|noscript|math|ins|del&#39;</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Tags&#160;where&#160;markdown=&#34;1&#34;&#160;default&#160;to&#160;span&#160;mode:</span><br/>
&#160;&#160;<span style='color: #000099;'><b>var</b></span>&#160;<span style='color: #990000;'><b>$contain_span_tags</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;p|h[1-6]|li|dd|dt|td|th|legend|address&#39;</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Tags&#160;which&#160;must&#160;not&#160;have&#160;their&#160;contents&#160;modified,&#160;no&#160;matter&#160;where</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;they&#160;appear:</span><br/>
&#160;&#160;<span style='color: #000099;'><b>var</b></span>&#160;<span style='color: #990000;'><b>$clean_tags</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;script|math&#39;</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Tags&#160;that&#160;do&#160;not&#160;need&#160;to&#160;be&#160;closed.</span><br/>
&#160;&#160;<span style='color: #000099;'><b>var</b></span>&#160;<span style='color: #990000;'><b>$auto_close_tags</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;hr|img&#39;</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;hashHTMLBlocks<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Hashify&#160;HTML&#160;Blocks&#160;and&#160;&#34;clean&#160;tags&#34;.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;We&#160;only&#160;want&#160;to&#160;do&#160;this&#160;for&#160;block-level&#160;HTML&#160;tags,&#160;such&#160;as&#160;headers,</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;lists,&#160;and&#160;tables.&#160;That&#39;s&#160;because&#160;we&#160;still&#160;want&#160;to&#160;wrap&#160;&#60;p&#62;s&#160;around</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#34;paragraphs&#34;&#160;that&#160;are&#160;wrapped&#160;in&#160;non-block-level&#160;tags,&#160;such&#160;as&#160;anchors,</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;phrase&#160;emphasis,&#160;and&#160;spans.&#160;The&#160;list&#160;of&#160;tags&#160;we&#39;re&#160;looking&#160;for&#160;is</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;hard-coded.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;This&#160;works&#160;by&#160;calling&#160;_HashHTMLBlocks_InMarkdown,&#160;which&#160;then&#160;calls</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;_HashHTMLBlocks_InHTML&#160;when&#160;it&#160;encounter&#160;block&#160;tags.&#160;When&#160;the&#160;markdown=&#34;1&#34;</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;attribute&#160;is&#160;found&#160;whitin&#160;a&#160;tag,&#160;_HashHTMLBlocks_InHTML&#160;calls&#160;back</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;_HashHTMLBlocks_InMarkdown&#160;to&#160;handle&#160;the&#160;Markdown&#160;syntax&#160;within&#160;the&#160;tag.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;These&#160;two&#160;functions&#160;are&#160;calling&#160;each&#160;other.&#160;It&#39;s&#160;recursive!</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Call&#160;the&#160;HTML-in-Markdown&#160;hasher.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;list<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>_hashHTMLBlocks_inMarkdown<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;_hashHTMLBlocks_inMarkdown<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$indent</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: purple;'>0</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$enclosing_tag</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$span</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #000099;'><b>false</b></span><span style='color: #0000FF;'>)</span><br/>
&#160;&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Parse&#160;markdown&#160;text,&#160;calling&#160;_HashHTMLBlocks_InHTML&#160;for&#160;block&#160;tags.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;*&#160;&#160;&#160;$indent&#160;is&#160;the&#160;number&#160;of&#160;space&#160;to&#160;be&#160;ignored&#160;when&#160;checking&#160;for&#160;code</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;&#160;blocks.&#160;This&#160;is&#160;important&#160;because&#160;if&#160;we&#160;don&#39;t&#160;take&#160;the&#160;indent&#160;into</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;&#160;account,&#160;something&#160;like&#160;this&#160;(which&#160;looks&#160;right)&#160;won&#39;t&#160;work&#160;as&#160;expected:</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;&#160;&#60;div&#62;</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#60;div&#160;markdown=&#34;1&#34;&#62;</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Hello&#160;World.&#160;&#160;&#60;--&#160;Is&#160;this&#160;a&#160;Markdown&#160;code&#160;block&#160;or&#160;text?</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#60;/div&#62;&#160;&#160;&#60;--&#160;Is&#160;this&#160;a&#160;Markdown&#160;code&#160;block&#160;or&#160;a&#160;real&#160;tag?</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;&#160;&#60;div&#62;</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;&#160;If&#160;you&#160;don&#39;t&#160;like&#160;this,&#160;just&#160;don&#39;t&#160;indent&#160;the&#160;tag&#160;on&#160;which</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;&#160;you&#160;apply&#160;the&#160;markdown=&#34;1&#34;&#160;attribute.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;*&#160;&#160;&#160;If&#160;$enclosing_tag&#160;is&#160;not&#160;empty,&#160;stops&#160;at&#160;the&#160;first&#160;unmatched&#160;closing</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;&#160;tag&#160;with&#160;that&#160;name.&#160;Nested&#160;tags&#160;supported.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;*&#160;&#160;&#160;If&#160;$span&#160;is&#160;true,&#160;text&#160;inside&#160;must&#160;treated&#160;as&#160;span.&#160;So&#160;any&#160;double</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;&#160;newline&#160;will&#160;be&#160;replaced&#160;by&#160;a&#160;single&#160;newline&#160;so&#160;that&#160;it&#160;does&#160;not&#160;create</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;&#160;paragraphs.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Returns&#160;an&#160;array&#160;of&#160;that&#160;form:&#160;(&#160;processed&#160;text&#160;,&#160;remaining&#160;text&#160;)</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;&#39;</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Regex&#160;to&#160;check&#160;for&#160;the&#160;presense&#160;of&#160;newlines&#160;around&#160;a&#160;block&#160;tag.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$newline_match_before</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;/(?:^\n?|\n\n)*$/&#39;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$newline_match_after</b></span>&#160;<span style='color: #0000FF;'>=</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#39;{</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;^&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;Start&#160;of&#160;text&#160;following&#160;the&#160;tag.</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?:[&#160;]*&#60;!--.*?--&#62;)?&#160;&#160;&#160;&#160;#&#160;Optional&#160;comment.</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#160;]*\n&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;Must&#160;be&#160;followed&#160;by&#160;newline.</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;}xs&#39;</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Regex&#160;to&#160;match&#160;any&#160;tag.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$block_tag_match</b></span>&#160;<span style='color: #0000FF;'>=</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#39;{</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;$2:&#160;Capture&#160;hole&#160;tag.</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#60;/?&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;Any&#160;opening&#160;or&#160;closing&#160;tag.</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?:&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;Tag&#160;name.</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>block_tags<span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;&#160;&#160;&#160;&#160;&#160;&#160;|</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>context_block_tags<span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;&#160;&#160;|</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>clean_tags<span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;|</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?!\s)&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$enclosing_tag</b></span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\s*&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;Whitespace.</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?:</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#34;.*?&#34;&#160;&#160;&#160;&#160;|&#160;&#160;#&#160;Double&#160;quotes&#160;(can&#160;contain&#160;`&#62;`)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\&#39;.*?\&#39;&#160;&#160;&#160;&#160;&#160;|&#160;&#160;#&#160;Single&#160;quotes&#160;(can&#160;contain&#160;`&#62;`)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;.+?&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;Anything&#160;but&#160;quotes&#160;and&#160;`&#62;`.</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)*?</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#62;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;End&#160;of&#160;tag.</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;|</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#60;!--&#160;&#160;&#160;&#160;.*?&#160;&#160;&#160;&#160;&#160;--&#62;&#160;&#160;#&#160;HTML&#160;Comment</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;|</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#60;\?.*?\?&#62;&#160;|&#160;&#60;%.*?%&#62;&#160;&#160;#&#160;Processing&#160;instruction</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;|</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#60;!\[CDATA\[.*?\]\]&#62;&#160;&#160;#&#160;CData&#160;Block</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;}xs&#39;</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$depth</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: purple;'>0</span><span style='color: #0000FF;'>;</span>&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Current&#160;depth&#160;inside&#160;the&#160;tag&#160;tree.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$parsed</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#34;</span><span style='color: #0000FF;'>;</span>&#160;&#160;<span style='color: #0099CC;'>#&#160;Parsed&#160;text&#160;that&#160;will&#160;be&#160;returned.</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Loop&#160;through&#160;every&#160;tag&#160;until&#160;we&#160;find&#160;the&#160;closing&#160;tag&#160;of&#160;the&#160;parent</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;or&#160;loop&#160;until&#160;reaching&#160;the&#160;end&#160;of&#160;text&#160;if&#160;no&#160;parent&#160;tag&#160;specified.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>do</b></span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Split&#160;the&#160;text&#160;using&#160;the&#160;first&#160;$tag_match&#160;pattern&#160;found.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Text&#160;before&#160;&#160;pattern&#160;will&#160;be&#160;first&#160;in&#160;the&#160;array,&#160;text&#160;after</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;pattern&#160;will&#160;be&#160;at&#160;the&#160;end,&#160;and&#160;between&#160;will&#160;be&#160;any&#160;catches&#160;made</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;by&#160;the&#160;pattern.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$parts</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_split</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$block_tag_match</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: purple;'>2</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;PREG_SPLIT_DELIM_CAPTURE<span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;If&#160;in&#160;Markdown&#160;span&#160;mode,&#160;add&#160;a&#160;empty-string&#160;span-level&#160;hash</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;after&#160;each&#160;newline&#160;to&#160;prevent&#160;triggering&#160;any&#160;block&#160;element.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$span</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$newline</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>hashSpan<span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#34;&#34;</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>.</span>&#160;<span style='color: #008800;'>&#34;\n&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$parts</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>0</span><span style='color: #0000FF;'>]</span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>str_replace</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#34;\n&#34;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$newline</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$parts</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>0</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$parsed</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$parts</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>0</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span>&#160;<span style='color: #0099CC;'>#&#160;Text&#160;before&#160;current&#160;tag.</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;If&#160;end&#160;of&#160;$text&#160;has&#160;been&#160;reached.&#160;Stop&#160;loop.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #ff0000;'>count</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$parts</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>&#60;</span>&#160;<span style='color: purple;'>3</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>break</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$tag</b></span>&#160;&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$parts</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span>&#160;<span style='color: #0099CC;'>#&#160;Tag&#160;to&#160;handle.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$parts</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>2</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span>&#160;<span style='color: #0099CC;'>#&#160;Remaining&#160;text&#160;after&#160;current&#160;tag.</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Check&#160;for:&#160;Tag&#160;inside&#160;code&#160;block&#160;or&#160;span</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #0099CC;'>#&#160;Find&#160;current&#160;paragraph</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #ff0000;'>preg_match</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;/(?&#62;^\n?|\n\n)((?&#62;.\n?)+?)$/&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$parsed</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>&#38;</span><span style='color: #0000FF;'>&#38;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>(</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Then&#160;match&#160;in&#160;it&#160;either&#160;a&#160;code&#160;block...</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #ff0000;'>preg_match</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;/^&#160;{&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$indent</b></span><span style='color: #0000FF;'>+</span><span style='color: purple;'>4</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;}.*(?&#62;\n&#160;{&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$indent</b></span><span style='color: #0000FF;'>+</span><span style='color: purple;'>4</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;}.*)*&#39;</span><span style='color: #0000FF;'>.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#39;(?!\n)$/&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$x</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>|</span><span style='color: #0000FF;'>|</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;...or&#160;unbalenced&#160;code&#160;span&#160;markers.&#160;(the&#160;regex&#160;matches&#160;balenced)</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>!</span><span style='color: #ff0000;'>preg_match</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;/^(?&#62;[^`]+|(`+)(?&#62;[^`]+|(?!\1[^`])`)*?\1(?!`))*$/s&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>)</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Tag&#160;is&#160;in&#160;code&#160;block&#160;or&#160;span&#160;and&#160;may&#160;not&#160;be&#160;a&#160;tag&#160;at&#160;all.&#160;So&#160;we</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;simply&#160;skip&#160;the&#160;first&#160;char&#160;(should&#160;be&#160;a&#160;`&#60;`).</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$parsed</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$tag</b></span><span style='color: #0000FF;'>{</span><span style='color: purple;'>0</span><span style='color: #0000FF;'>}</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>substr</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$tag</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: purple;'>1</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>.</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>;</span>&#160;<span style='color: #0099CC;'>#&#160;Put&#160;back&#160;$tag&#160;minus&#160;first&#160;char.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Check&#160;for:&#160;Opening&#160;Block&#160;level&#160;tag&#160;or</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Opening&#160;Content&#160;Block&#160;tag&#160;(like&#160;ins&#160;and&#160;del)</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;used&#160;as&#160;a&#160;block&#160;tag&#160;(tag&#160;is&#160;alone&#160;on&#160;it&#39;s&#160;line).</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>else</b></span>&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #ff0000;'>preg_match</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#34;{^&#60;(?:$this-&#62;block_tags)\b}&#34;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$tag</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>|</span><span style='color: #0000FF;'>|</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>(</span>&#160;&#160;<span style='color: #ff0000;'>preg_match</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#34;{^&#60;(?:$this-&#62;context_block_tags)\b}&#34;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$tag</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>&#38;</span><span style='color: #0000FF;'>&#38;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #ff0000;'>preg_match</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$newline_match_before</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$parsed</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>&#38;</span><span style='color: #0000FF;'>&#38;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #ff0000;'>preg_match</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$newline_match_after</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;&#160;<span style='color: #0000FF;'>)</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>)</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Need&#160;to&#160;parse&#160;tag&#160;and&#160;following&#160;text&#160;using&#160;the&#160;HTML&#160;parser.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;list<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$block_text</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>=</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>_hashHTMLBlocks_inHTML<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$tag</b></span>&#160;<span style='color: #0000FF;'>.</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#34;hashBlock&#34;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #000099;'><b>true</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Make&#160;sure&#160;it&#160;stays&#160;outside&#160;of&#160;any&#160;paragraph&#160;by&#160;adding&#160;newlines.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$parsed</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;\n\n$block_text\n\n&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Check&#160;for:&#160;Clean&#160;tag&#160;(like&#160;script,&#160;math)</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;HTML&#160;Comments,&#160;processing&#160;instructions.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>else</b></span>&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #ff0000;'>preg_match</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#34;{^&#60;(?:$this-&#62;clean_tags)\b}&#34;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$tag</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>|</span><span style='color: #0000FF;'>|</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$tag</b></span><span style='color: #0000FF;'>{</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>}</span>&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;!&#39;</span>&#160;<span style='color: #0000FF;'>|</span><span style='color: #0000FF;'>|</span>&#160;<span style='color: #990000;'><b>$tag</b></span><span style='color: #0000FF;'>{</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>}</span>&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;?&#39;</span><span style='color: #0000FF;'>)</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Need&#160;to&#160;parse&#160;tag&#160;and&#160;following&#160;text&#160;using&#160;the&#160;HTML&#160;parser.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;(don&#39;t&#160;check&#160;for&#160;markdown&#160;attribute)</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;list<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$block_text</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>=</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>_hashHTMLBlocks_inHTML<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$tag</b></span>&#160;<span style='color: #0000FF;'>.</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#34;hashClean&#34;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #000099;'><b>false</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$parsed</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$block_text</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Check&#160;for:&#160;Tag&#160;with&#160;same&#160;name&#160;as&#160;enclosing&#160;tag.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>else</b></span>&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$enclosing_tag</b></span>&#160;<span style='color: #0000FF;'>!</span><span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;&#39;</span>&#160;<span style='color: #0000FF;'>&#38;</span><span style='color: #0000FF;'>&#38;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Same&#160;name&#160;as&#160;enclosing&#160;tag.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #ff0000;'>preg_match</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#34;{^&#60;/?(?:$enclosing_tag)\b}&#34;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$tag</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Increase/decrease&#160;nested&#160;tag&#160;count.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$tag</b></span><span style='color: #0000FF;'>{</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>}</span>&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;/&#39;</span><span style='color: #0000FF;'>)</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$depth</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>else</b></span>&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$tag</b></span><span style='color: #0000FF;'>{</span><span style='color: #ff0000;'>strlen</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$tag</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>-</span><span style='color: purple;'>2</span><span style='color: #0000FF;'>}</span>&#160;<span style='color: #0000FF;'>!</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;/&#39;</span><span style='color: #0000FF;'>)</span>&#160;&#160;<span style='color: #990000;'><b>$depth</b></span><span style='color: #0000FF;'>+</span><span style='color: #0000FF;'>+</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$depth</b></span>&#160;<span style='color: #0000FF;'>&#60;</span>&#160;<span style='color: purple;'>0</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Going&#160;out&#160;of&#160;parent&#160;element.&#160;Clean&#160;up&#160;and&#160;break&#160;so&#160;we</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;return&#160;to&#160;the&#160;calling&#160;function.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$tag</b></span>&#160;<span style='color: #0000FF;'>.</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>break</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$parsed</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$tag</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>else</b></span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$parsed</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$tag</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span>&#160;<span style='color: #000099;'><b>while</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$depth</b></span>&#160;<span style='color: #0000FF;'>&#62;</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: purple;'>0</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$parsed</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;_hashHTMLBlocks_inHTML<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$hash_method</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$md_attr</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Parse&#160;HTML,&#160;calling&#160;_HashHTMLBlocks_InMarkdown&#160;for&#160;block&#160;tags.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;*&#160;&#160;&#160;Calls&#160;$hash_method&#160;to&#160;convert&#160;any&#160;blocks.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;*&#160;&#160;&#160;Stops&#160;when&#160;the&#160;first&#160;opening&#160;tag&#160;closes.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;*&#160;&#160;&#160;$md_attr&#160;indicate&#160;if&#160;the&#160;use&#160;of&#160;the&#160;`markdown=&#34;1&#34;`&#160;attribute&#160;is&#160;allowed.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;&#160;(it&#160;is&#160;not&#160;inside&#160;clean&#160;tags)</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Returns&#160;an&#160;array&#160;of&#160;that&#160;form:&#160;(&#160;processed&#160;text&#160;,&#160;remaining&#160;text&#160;)</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;&#39;</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Regex&#160;to&#160;match&#160;`markdown`&#160;attribute&#160;inside&#160;of&#160;a&#160;tag.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$markdown_attr_match</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;{</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\s*&#160;&#160;&#160;&#160;&#160;&#160;#&#160;Eat&#160;whitespace&#160;before&#160;the&#160;`markdown`&#160;attribute</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;markdown</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\s*=\s*</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;([&#34;\&#39;])&#160;&#160;&#160;&#160;#&#160;$1:&#160;quote&#160;delimiter</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(.*?)&#160;&#160;&#160;&#160;#&#160;$2:&#160;attribute&#160;value</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\1&#160;&#160;&#160;&#160;&#160;&#160;#&#160;matching&#160;delimiter</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;}xs&#39;</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Regex&#160;to&#160;match&#160;any&#160;tag.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$tag_match</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;{</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;$2:&#160;Capture&#160;hole&#160;tag.</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#60;/?&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;Any&#160;opening&#160;or&#160;closing&#160;tag.</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[\w:$]+&#160;&#160;&#160;&#160;&#160;&#160;#&#160;Tag&#160;name.</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\s*&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;Whitespace.</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?:</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#34;.*?&#34;&#160;&#160;&#160;&#160;|&#160;&#160;#&#160;Double&#160;quotes&#160;(can&#160;contain&#160;`&#62;`)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\&#39;.*?\&#39;&#160;&#160;&#160;&#160;&#160;|&#160;&#160;#&#160;Single&#160;quotes&#160;(can&#160;contain&#160;`&#62;`)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;.+?&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;Anything&#160;but&#160;quotes&#160;and&#160;`&#62;`.</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)*?</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#62;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;End&#160;of&#160;tag.</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;|</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#60;!--&#160;&#160;&#160;&#160;.*?&#160;&#160;&#160;&#160;&#160;--&#62;&#160;&#160;#&#160;HTML&#160;Comment</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;|</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#60;\?.*?\?&#62;&#160;|&#160;&#60;%.*?%&#62;&#160;&#160;#&#160;Processing&#160;instruction</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;|</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#60;!\[CDATA\[.*?\]\]&#62;&#160;&#160;#&#160;CData&#160;Block</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;}xs&#39;</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$original_text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>;</span>&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Save&#160;original&#160;text&#160;in&#160;case&#160;of&#160;faliure.</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$depth</b></span>&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: purple;'>0</span><span style='color: #0000FF;'>;</span>&#160;&#160;<span style='color: #0099CC;'>#&#160;Current&#160;depth&#160;inside&#160;the&#160;tag&#160;tree.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$block_text</b></span>&#160;&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#34;</span><span style='color: #0000FF;'>;</span>&#160;&#160;<span style='color: #0099CC;'>#&#160;Temporary&#160;text&#160;holder&#160;for&#160;current&#160;text.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$parsed</b></span>&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#34;</span><span style='color: #0000FF;'>;</span>&#160;&#160;<span style='color: #0099CC;'>#&#160;Parsed&#160;text&#160;that&#160;will&#160;be&#160;returned.</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Get&#160;the&#160;name&#160;of&#160;the&#160;starting&#160;tag.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #ff0000;'>preg_match</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#34;/^&#60;([\w:$]*)\b/&#34;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$base_tag_name</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>else</b></span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$base_tag_name</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;null<span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Loop&#160;through&#160;every&#160;tag&#160;until&#160;we&#160;find&#160;the&#160;corresponding&#160;closing&#160;tag.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>do</b></span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Split&#160;the&#160;text&#160;using&#160;the&#160;first&#160;$tag_match&#160;pattern&#160;found.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Text&#160;before&#160;&#160;pattern&#160;will&#160;be&#160;first&#160;in&#160;the&#160;array,&#160;text&#160;after</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;pattern&#160;will&#160;be&#160;at&#160;the&#160;end,&#160;and&#160;between&#160;will&#160;be&#160;any&#160;catches&#160;made</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;by&#160;the&#160;pattern.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$parts</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_split</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$tag_match</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: purple;'>2</span><span style='color: #0000FF;'>,</span>&#160;PREG_SPLIT_DELIM_CAPTURE<span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #ff0000;'>count</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$parts</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>&#60;</span>&#160;<span style='color: purple;'>3</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;End&#160;of&#160;$text&#160;reached&#160;with&#160;unbalenced&#160;tag(s).</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;In&#160;that&#160;case,&#160;we&#160;return&#160;original&#160;text&#160;unchanged&#160;and&#160;pass&#160;the</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;first&#160;character&#160;as&#160;filtered&#160;to&#160;prevent&#160;an&#160;infinite&#160;loop&#160;in&#160;the</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;parent&#160;function.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$original_text</b></span><span style='color: #0000FF;'>{</span><span style='color: purple;'>0</span><span style='color: #0000FF;'>}</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #ff0000;'>substr</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$original_text</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: purple;'>1</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$block_text</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$parts</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>0</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span>&#160;<span style='color: #0099CC;'>#&#160;Text&#160;before&#160;current&#160;tag.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$tag</b></span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$parts</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span>&#160;<span style='color: #0099CC;'>#&#160;Tag&#160;to&#160;handle.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$parts</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>2</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span>&#160;<span style='color: #0099CC;'>#&#160;Remaining&#160;text&#160;after&#160;current&#160;tag.</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Check&#160;for:&#160;Auto-close&#160;tag&#160;(like&#160;&#60;hr/&#62;)</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;&#160;&#160;&#160;Comments&#160;and&#160;Processing&#160;Instructions.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #ff0000;'>preg_match</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#34;{^&#60;/?(?:$this-&#62;auto_close_tags)\b}&#34;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$tag</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>|</span><span style='color: #0000FF;'>|</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$tag</b></span><span style='color: #0000FF;'>{</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>}</span>&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;!&#39;</span>&#160;<span style='color: #0000FF;'>|</span><span style='color: #0000FF;'>|</span>&#160;<span style='color: #990000;'><b>$tag</b></span><span style='color: #0000FF;'>{</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>}</span>&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;?&#39;</span><span style='color: #0000FF;'>)</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Just&#160;add&#160;the&#160;tag&#160;to&#160;the&#160;block&#160;as&#160;if&#160;it&#160;was&#160;text.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$block_text</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$tag</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>else</b></span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Increase/decrease&#160;nested&#160;tag&#160;count.&#160;Only&#160;do&#160;so&#160;if</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;the&#160;tag&#39;s&#160;name&#160;match&#160;base&#160;tag&#39;s.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #ff0000;'>preg_match</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#34;{^&#60;/?$base_tag_name\b}&#34;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$tag</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$tag</b></span><span style='color: #0000FF;'>{</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>}</span>&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;/&#39;</span><span style='color: #0000FF;'>)</span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$depth</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>else</b></span>&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$tag</b></span><span style='color: #0000FF;'>{</span><span style='color: #ff0000;'>strlen</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$tag</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>-</span><span style='color: purple;'>2</span><span style='color: #0000FF;'>}</span>&#160;<span style='color: #0000FF;'>!</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;/&#39;</span><span style='color: #0000FF;'>)</span>&#160;&#160;<span style='color: #990000;'><b>$depth</b></span><span style='color: #0000FF;'>+</span><span style='color: #0000FF;'>+</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Check&#160;for&#160;`markdown=&#34;1&#34;`&#160;attribute&#160;and&#160;handle&#160;it.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$md_attr</b></span>&#160;<span style='color: #0000FF;'>&#38;</span><span style='color: #0000FF;'>&#38;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #ff0000;'>preg_match</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$markdown_attr_match</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$tag</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$attr_matches</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>&#38;</span><span style='color: #0000FF;'>&#38;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #ff0000;'>preg_match</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;/^1|block|span$/&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$attr_matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>2</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Remove&#160;`markdown`&#160;attribute&#160;from&#160;opening&#160;tag.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$tag</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$markdown_attr_match</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$tag</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Check&#160;if&#160;text&#160;inside&#160;this&#160;tag&#160;must&#160;be&#160;parsed&#160;in&#160;span&#160;mode.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>mode&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$attr_matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>2</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$span_mode</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>mode&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;span&#39;</span>&#160;<span style='color: #0000FF;'>|</span><span style='color: #0000FF;'>|</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>mode&#160;<span style='color: #0000FF;'>!</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;block&#39;</span>&#160;<span style='color: #0000FF;'>&#38;</span><span style='color: #0000FF;'>&#38;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #ff0000;'>preg_match</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#34;{^&#60;(?:$this-&#62;contain_span_tags)\b}&#34;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$tag</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Calculate&#160;indent&#160;before&#160;tag.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #ff0000;'>preg_match</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;/(?:^|\n)(&#160;*?)(?!&#160;).*?$/&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$block_text</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$indent</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>strlen</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;End&#160;preceding&#160;block&#160;with&#160;this&#160;tag.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$block_text</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$tag</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$parsed</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span><span style='color: #990000;'><b>$hash_method</b></span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$block_text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Get&#160;enclosing&#160;tag&#160;name&#160;for&#160;the&#160;ParseMarkdown&#160;function.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #ff0000;'>preg_match</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;/^&#60;([\w:$]*)\b/&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$tag</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$tag_name</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Parse&#160;the&#160;content&#160;using&#160;the&#160;HTML-in-Markdown&#160;parser.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;list&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$block_text</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>_hashHTMLBlocks_inMarkdown<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$indent</b></span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$tag_name</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$span_mode</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Outdent&#160;markdown&#160;text.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$indent</b></span>&#160;<span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: purple;'>0</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$block_text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#34;/^[&#160;]{1,$indent}/m&#34;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#34;&#34;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$block_text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Append&#160;tag&#160;content&#160;to&#160;parsed&#160;text.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>!</span><span style='color: #990000;'><b>$span_mode</b></span><span style='color: #0000FF;'>)</span>&#160;&#160;<span style='color: #990000;'><b>$parsed</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;\n\n$block_text\n\n&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>else</b></span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$parsed</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;$block_text&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Start&#160;over&#160;a&#160;new&#160;block.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$block_text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>else</b></span>&#160;<span style='color: #990000;'><b>$block_text</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$tag</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span>&#160;<span style='color: #000099;'><b>while</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$depth</b></span>&#160;<span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: purple;'>0</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Hash&#160;last&#160;block&#160;text&#160;that&#160;wasn&#39;t&#160;processed&#160;inside&#160;the&#160;loop.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$parsed</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span><span style='color: #990000;'><b>$hash_method</b></span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$block_text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$parsed</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;hashClean<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Called&#160;whenever&#160;a&#160;tag&#160;must&#160;be&#160;hashed&#160;when&#160;a&#160;function&#160;insert&#160;a&#160;&#34;clean&#34;&#160;tag</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;in&#160;$text,&#160;it&#160;pass&#160;through&#160;this&#160;function&#160;and&#160;is&#160;automaticaly&#160;escaped,</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;blocking&#160;invalid&#160;nested&#160;overlap.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Swap&#160;back&#160;any&#160;tag&#160;hash&#160;found&#160;in&#160;$text&#160;so&#160;we&#160;do&#160;not&#160;have&#160;to&#160;`unhash`</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;multiple&#160;times&#160;at&#160;the&#160;end.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>unhash<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Then&#160;hash&#160;the&#160;tag.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$key</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>md5</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>html_cleans<span style='color: #0000FF;'>[</span><span style='color: #990000;'><b>$key</b></span><span style='color: #0000FF;'>]</span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>html_hashes<span style='color: #0000FF;'>[</span><span style='color: #990000;'><b>$key</b></span><span style='color: #0000FF;'>]</span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$key</b></span><span style='color: #0000FF;'>;</span>&#160;<span style='color: #0099CC;'>#&#160;String&#160;that&#160;will&#160;replace&#160;the&#160;clean&#160;tag.</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;doHeaders<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Redefined&#160;to&#160;add&#160;id&#160;attribute&#160;support.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Setext-style&#160;headers:</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;Header&#160;1&#160;&#160;{#header1}</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;========</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;Header&#160;2&#160;&#160;{#header2}</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;--------</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace_callback</span><span style='color: #0000FF;'>(</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#39;{&#160;(^.+?)&#160;(?:[&#160;]+\{\#([-_:a-zA-Z0-9]+)\})?&#160;[&#160;\t]*\n=+[&#160;\t]*\n+&#160;}mx&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>&#38;</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;_doHeaders_callback_setext_h1&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace_callback</span><span style='color: #0000FF;'>(</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#39;{&#160;(^.+?)&#160;(?:[&#160;]+\{\#([-_:a-zA-Z0-9]+)\})?&#160;[&#160;\t]*\n-+[&#160;\t]*\n+&#160;}mx&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>&#38;</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;_doHeaders_callback_setext_h2&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;atx-style&#160;headers:</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;#&#160;Header&#160;1&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;{#header1}</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;##&#160;Header&#160;2&#160;&#160;&#160;&#160;&#160;&#160;&#160;{#header2}</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;##&#160;Header&#160;2&#160;with&#160;closing&#160;hashes&#160;##&#160;&#160;{#header3}</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;...</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;######&#160;Header&#160;6&#160;&#160;&#160;{#header2}</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace_callback</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;{</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;^(\#{1,6})&#160;&#160;#&#160;$1&#160;=&#160;string&#160;of&#160;#\&#39;s</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#160;\t]*</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(.+?)&#160;&#160;&#160;&#160;#&#160;$2&#160;=&#160;Header&#160;text</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#160;\t]*</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\#*&#160;&#160;&#160;&#160;&#160;&#160;#&#160;optional&#160;closing&#160;#\&#39;s&#160;(not&#160;counted)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?:[&#160;]+\{\#([-_:a-zA-Z0-9]+)\})?&#160;#&#160;id&#160;attribute</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#160;\t]*</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\n+</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;}xm&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>&#38;</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;_doHeaders_callback_atx&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;_doHeaders_attr<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$attr</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #000099;'><b>empty</b></span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$attr</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span>&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #008800;'>&#34;&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #008800;'>&#34;&#160;id=\&#34;$attr\&#34;&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;_doHeaders_callback_setext_h1<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$attr</b></span>&#160;&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>_doHeaders_attr<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$id</b></span>&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#38;</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>2</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$block</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#60;h1$attr&#62;&#34;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>runSpanGamut<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#34;&#60;/h1&#62;&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #008800;'>&#34;\n&#34;</span>&#160;<span style='color: #0000FF;'>.</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>hashBlock<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$block</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>.</span>&#160;<span style='color: #008800;'>&#34;\n\n&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;_doHeaders_callback_setext_h2<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$attr</b></span>&#160;&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>_doHeaders_attr<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$id</b></span>&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#38;</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>2</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$block</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#60;h2$attr&#62;&#34;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>runSpanGamut<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#34;&#60;/h2&#62;&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #008800;'>&#34;\n&#34;</span>&#160;<span style='color: #0000FF;'>.</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>hashBlock<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$block</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>.</span>&#160;<span style='color: #008800;'>&#34;\n\n&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;_doHeaders_callback_atx<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$level</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>strlen</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$attr</b></span>&#160;&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>_doHeaders_attr<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$id</b></span>&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#38;</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>3</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$block</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#60;h$level$attr&#62;&#34;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>runSpanGamut<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>2</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#34;&#60;/h$level&#62;&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #008800;'>&#34;\n&#34;</span>&#160;<span style='color: #0000FF;'>.</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>hashBlock<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$block</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>.</span>&#160;<span style='color: #008800;'>&#34;\n\n&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;doTables<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Form&#160;HTML&#160;tables.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$less_than_tab</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>tab_width&#160;<span style='color: #0000FF;'>-</span>&#160;<span style='color: purple;'>1</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Find&#160;tables&#160;with&#160;leading&#160;pipe.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;|&#160;Header&#160;1&#160;|&#160;Header&#160;2</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;|&#160;--------&#160;|&#160;--------</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;|&#160;Cell&#160;1&#160;&#160;&#160;|&#160;Cell&#160;2</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;|&#160;Cell&#160;3&#160;&#160;&#160;|&#160;Cell&#160;4</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace_callback</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;{</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;^&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;Start&#160;of&#160;a&#160;line</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#160;]{0,&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$less_than_tab</b></span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;}&#160;&#160;#&#160;Allowed&#160;whitespace.</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[|]&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;Optional&#160;leading&#160;pipe&#160;(present)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(.+)&#160;\n&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;$1:&#160;Header&#160;row&#160;(at&#160;least&#160;one&#160;pipe)</span><br/>
<span style='color: #008800;'>&#160;</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#160;]{0,&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$less_than_tab</b></span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;}&#160;&#160;#&#160;Allowed&#160;whitespace.</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[|]&#160;([&#160;]*[-:]+[-|&#160;:]*)&#160;\n&#160;&#160;#&#160;$2:&#160;Header&#160;underline</span><br/>
<span style='color: #008800;'>&#160;</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;$3:&#160;Cells</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?:</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#160;]*&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;Allowed&#160;whitespace.</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[|]&#160;.*&#160;\n&#160;&#160;&#160;&#160;&#160;&#160;#&#160;Row&#160;content.</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)*</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?=\n|\Z)&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;Stop&#160;at&#160;final&#160;double&#160;newline.</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;}xm&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>&#38;</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;_doTable_leadingPipe_callback&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Find&#160;tables&#160;without&#160;leading&#160;pipe.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;Header&#160;1&#160;|&#160;Header&#160;2</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;--------&#160;|&#160;--------</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;Cell&#160;1&#160;&#160;&#160;|&#160;Cell&#160;2</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;Cell&#160;3&#160;&#160;&#160;|&#160;Cell&#160;4</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace_callback</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;{</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;^&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;Start&#160;of&#160;a&#160;line</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#160;]{0,&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$less_than_tab</b></span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;}&#160;&#160;#&#160;Allowed&#160;whitespace.</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(\S.*[|].*)&#160;\n&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;$1:&#160;Header&#160;row&#160;(at&#160;least&#160;one&#160;pipe)</span><br/>
<span style='color: #008800;'>&#160;</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#160;]{0,&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$less_than_tab</b></span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;}&#160;&#160;#&#160;Allowed&#160;whitespace.</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;([-:]+[&#160;]*[|][-|&#160;:]*)&#160;\n&#160;&#160;#&#160;$2:&#160;Header&#160;underline</span><br/>
<span style='color: #008800;'>&#160;</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;$3:&#160;Cells</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?:</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;.*&#160;[|]&#160;.*&#160;\n&#160;&#160;&#160;&#160;#&#160;Row&#160;content</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)*</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?=\n|\Z)&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;Stop&#160;at&#160;final&#160;double&#160;newline.</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;}xm&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>&#38;</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;_DoTable_callback&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;_doTable_leadingPipe_callback<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$head</b></span>&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$underline</b></span>&#160;&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>2</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$content</b></span>&#160;&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>3</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Remove&#160;leading&#160;pipe&#160;for&#160;each&#160;row.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$content</b></span>&#160;&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;/^&#160;*[|]/m&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$content</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>_doTable_callback<span style='color: #0000FF;'>(</span><span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>0</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$head</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$underline</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$content</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;_doTable_callback<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$head</b></span>&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$underline</b></span>&#160;&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>2</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$content</b></span>&#160;&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>3</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Remove&#160;any&#160;tailing&#160;pipes&#160;for&#160;each&#160;line.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$head</b></span>&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;/[|]&#160;*$/m&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$head</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$underline</b></span>&#160;&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;/[|]&#160;*$/m&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$underline</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$content</b></span>&#160;&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;/[|]&#160;*$/m&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$content</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Reading&#160;alignement&#160;from&#160;header&#160;underline.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$separators</b></span>&#160;&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_split</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;/&#160;*[|]&#160;*/&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$underline</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>foreach</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$separators</b></span>&#160;<span style='color: #000099;'><b>as</b></span>&#160;<span style='color: #990000;'><b>$n</b></span>&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: #990000;'><b>$s</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #ff0000;'>preg_match</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;/^&#160;*-+:&#160;*$/&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$s</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span>&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$attr</b></span><span style='color: #0000FF;'>[</span><span style='color: #990000;'><b>$n</b></span><span style='color: #0000FF;'>]</span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;&#160;align=&#34;right&#34;&#39;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>else</b></span>&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #ff0000;'>preg_match</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;/^&#160;*:-+:&#160;*$/&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$s</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span><span style='color: #990000;'><b>$attr</b></span><span style='color: #0000FF;'>[</span><span style='color: #990000;'><b>$n</b></span><span style='color: #0000FF;'>]</span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;&#160;align=&#34;center&#34;&#39;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>else</b></span>&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #ff0000;'>preg_match</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;/^&#160;*:-+&#160;*$/&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$s</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span>&#160;&#160;<span style='color: #990000;'><b>$attr</b></span><span style='color: #0000FF;'>[</span><span style='color: #990000;'><b>$n</b></span><span style='color: #0000FF;'>]</span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;&#160;align=&#34;left&#34;&#39;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>else</b></span>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$attr</b></span><span style='color: #0000FF;'>[</span><span style='color: #990000;'><b>$n</b></span><span style='color: #0000FF;'>]</span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;&#39;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Creating&#160;code&#160;spans&#160;before&#160;splitting&#160;the&#160;row&#160;is&#160;an&#160;easy&#160;way&#160;to</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;handle&#160;a&#160;code&#160;span&#160;containg&#160;pipes.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$head</b></span>&#160;&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>doCodeSpans<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$head</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$headers</b></span>&#160;&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_split</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;/&#160;*[|]&#160;*/&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$head</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$col_count</b></span>&#160;&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>count</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$headers</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Write&#160;column&#160;headers.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#60;table&#62;\n&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#60;thead&#62;\n&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#60;tr&#62;\n&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>foreach</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$headers</b></span>&#160;<span style='color: #000099;'><b>as</b></span>&#160;<span style='color: #990000;'><b>$n</b></span>&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: #990000;'><b>$header</b></span><span style='color: #0000FF;'>)</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#160;&#160;&#60;th$attr[$n]&#62;&#34;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>runSpanGamut<span style='color: #0000FF;'>(</span><span style='color: #ff0000;'>trim</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$header</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#34;&#60;/th&#62;\n&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#60;/tr&#62;\n&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#60;/thead&#62;\n&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Split&#160;content&#160;by&#160;row.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$rows</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>explode</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#34;\n&#34;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #ff0000;'>trim</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$content</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#34;\n&#34;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#60;tbody&#62;\n&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>foreach</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$rows</b></span>&#160;<span style='color: #000099;'><b>as</b></span>&#160;<span style='color: #990000;'><b>$row</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Creating&#160;code&#160;spans&#160;before&#160;splitting&#160;the&#160;row&#160;is&#160;an&#160;easy&#160;way&#160;to</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;handle&#160;a&#160;code&#160;span&#160;containg&#160;pipes.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$row</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>doCodeSpans<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$row</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Split&#160;row&#160;by&#160;cell.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$row_cells</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_split</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;/&#160;*[|]&#160;*/&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$row</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$col_count</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$row_cells</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>array_pad</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$row_cells</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$col_count</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#60;tr&#62;\n&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>foreach</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$row_cells</b></span>&#160;<span style='color: #000099;'><b>as</b></span>&#160;<span style='color: #990000;'><b>$n</b></span>&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: #990000;'><b>$cell</b></span><span style='color: #0000FF;'>)</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#160;&#160;&#60;td$attr[$n]&#62;&#34;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>runSpanGamut<span style='color: #0000FF;'>(</span><span style='color: #ff0000;'>trim</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$cell</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#34;&#60;/td&#62;\n&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#60;/tr&#62;\n&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#60;/tbody&#62;\n&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#60;/table&#62;&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>hashBlock<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>.</span>&#160;<span style='color: #008800;'>&#34;\n&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;doDefLists<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Form&#160;HTML&#160;definition&#160;lists.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$less_than_tab</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>tab_width&#160;<span style='color: #0000FF;'>-</span>&#160;<span style='color: purple;'>1</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Re-usable&#160;pattern&#160;to&#160;match&#160;any&#160;entire&#160;dl&#160;list:</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$whole_list</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;(&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;$1&#160;=&#160;whole&#160;list</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;$2</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#160;]{0,&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$less_than_tab</b></span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;}</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;((?&#62;.*\S.*\n)+)&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;$3&#160;=&#160;defined&#160;term</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\n?</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#160;]{0,&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$less_than_tab</b></span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;}:[&#160;]+&#160;#&#160;colon&#160;starting&#160;definition</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?s:.+?)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;$4</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\z</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;|</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\n{2,}</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?=\S)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?!&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;Negative&#160;lookahead&#160;for&#160;another&#160;term</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#160;]{0,&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$less_than_tab</b></span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;}</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?:&#160;\S.*\n&#160;)+?&#160;&#160;&#160;&#160;&#160;&#160;#&#160;defined&#160;term</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\n?</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#160;]{0,&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$less_than_tab</b></span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;}:[&#160;]+&#160;#&#160;colon&#160;starting&#160;definition</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?!&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;Negative&#160;lookahead&#160;for&#160;another&#160;definition</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#160;]{0,&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$less_than_tab</b></span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;}:[&#160;]+&#160;#&#160;colon&#160;starting&#160;definition</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#39;</span><span style='color: #0000FF;'>;</span>&#160;<span style='color: #0099CC;'>//&#160;mx</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace_callback</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;{</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?:(?&#60;=\n\n)|\A\n?)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$whole_list</b></span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;}mx&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>&#38;</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;_doDefLists_callback&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;_doDefLists_callback<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Re-usable&#160;patterns&#160;to&#160;match&#160;list&#160;item&#160;bullets&#160;and&#160;number&#160;markers:</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$list</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Turn&#160;double&#160;returns&#160;into&#160;triple&#160;returns,&#160;so&#160;that&#160;we&#160;can&#160;make&#160;a</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;paragraph&#160;for&#160;the&#160;last&#160;item&#160;in&#160;a&#160;list,&#160;if&#160;necessary:</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$result</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>trim</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>processDefListItems<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$list</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$result</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#60;dl&#62;\n&#34;</span>&#160;<span style='color: #0000FF;'>.</span>&#160;<span style='color: #990000;'><b>$result</b></span>&#160;<span style='color: #0000FF;'>.</span>&#160;<span style='color: #008800;'>&#34;\n&#60;/dl&#62;&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>hashBlock<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$result</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>.</span>&#160;<span style='color: #008800;'>&#34;\n\n&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;processDefListItems<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$list_str</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;Process&#160;the&#160;contents&#160;of&#160;a&#160;single&#160;definition&#160;list,&#160;splitting&#160;it</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;into&#160;individual&#160;term&#160;and&#160;definition&#160;list&#160;items.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$less_than_tab</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>tab_width&#160;<span style='color: #0000FF;'>-</span>&#160;<span style='color: purple;'>1</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;trim&#160;trailing&#160;blank&#160;lines:</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$list_str</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#34;/\n{2,}\\z/&#34;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#34;\n&#34;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$list_str</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Process&#160;definition&#160;terms.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$list_str</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace_callback</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;{</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;(?:\n\n+|\A\n?)&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;leading&#160;line</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;(&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;definition&#160;terms&#160;=&#160;$1</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#160;]{0,&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$less_than_tab</b></span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;}&#160;&#160;#&#160;leading&#160;whitespace</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?![:][&#160;]|[&#160;])&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;negative&#160;lookahead&#160;for&#160;a&#160;definition</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;&#160;&#160;mark&#160;(colon)&#160;or&#160;more&#160;whitespace.</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?:&#160;\S.*&#160;\n)+?&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;actual&#160;term&#160;(not&#160;whitespace).</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;(?=\n?[&#160;]{0,3}:[&#160;])&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;lookahead&#160;for&#160;following&#160;line&#160;feed</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;&#160;&#160;with&#160;a&#160;definition&#160;mark.</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;}xm&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>&#38;</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;_processDefListItems_callback_dt&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$list_str</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Process&#160;actual&#160;definitions.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$list_str</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace_callback</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;{</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;\n(\n+)?&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;leading&#160;line&#160;=&#160;$1</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;[&#160;]{0,&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$less_than_tab</b></span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;}&#160;&#160;&#160;&#160;#&#160;whitespace&#160;before&#160;colon</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;[:][&#160;]+&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;definition&#160;mark&#160;(colon)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;((?s:.+?))&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;definition&#160;text&#160;=&#160;$2</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;(?=&#160;\n+&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;stop&#160;at&#160;next&#160;definition&#160;mark,</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?:&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;next&#160;term&#160;or&#160;end&#160;of&#160;text</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#160;]{0,&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$less_than_tab</b></span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;}&#160;[:][&#160;]&#160;&#160;|</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#60;dt&#62;&#160;|&#160;\z</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;}xm&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>&#38;</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;_processDefListItems_callback_dd&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$list_str</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$list_str</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;_processDefListItems_callback_dt<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$terms</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>explode</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#34;\n&#34;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #ff0000;'>trim</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;&#39;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>foreach</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$terms</b></span>&#160;<span style='color: #000099;'><b>as</b></span>&#160;<span style='color: #990000;'><b>$term</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$term</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>runSpanGamut<span style='color: #0000FF;'>(</span><span style='color: #ff0000;'>trim</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$term</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;\n&#60;dt&#62;&#34;</span>&#160;<span style='color: #0000FF;'>.</span>&#160;<span style='color: #990000;'><b>$term</b></span>&#160;<span style='color: #0000FF;'>.</span>&#160;<span style='color: #008800;'>&#34;&#60;/dt&#62;&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>.</span>&#160;<span style='color: #008800;'>&#34;\n&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;_processDefListItems_callback_dd<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$leading_line</b></span>&#160;&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$def</b></span>&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>2</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$leading_line</b></span>&#160;<span style='color: #0000FF;'>|</span><span style='color: #0000FF;'>|</span>&#160;<span style='color: #ff0000;'>preg_match</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;/\n{2,}/&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$def</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$def</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>runBlockGamut<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>outdent<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$def</b></span>&#160;<span style='color: #0000FF;'>.</span>&#160;<span style='color: #008800;'>&#34;\n\n&#34;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$def</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;\n&#34;</span><span style='color: #0000FF;'>.</span>&#160;<span style='color: #990000;'><b>$def</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#34;\n&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>else</b></span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$def</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>rtrim</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$def</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$def</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>runSpanGamut<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>outdent<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$def</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #008800;'>&#34;\n&#60;dd&#62;&#34;</span>&#160;<span style='color: #0000FF;'>.</span>&#160;<span style='color: #990000;'><b>$def</b></span>&#160;<span style='color: #0000FF;'>.</span>&#160;<span style='color: #008800;'>&#34;&#60;/dd&#62;\n&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;doItalicsAndBold<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Redefined&#160;to&#160;change&#160;emphasis&#160;by&#160;underscore&#160;behaviour&#160;so&#160;that&#160;it&#160;does&#160;not</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;work&#160;in&#160;the&#160;middle&#160;of&#160;a&#160;word.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;&#60;strong&#62;&#160;must&#160;go&#160;first:</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace_callback</span><span style='color: #0000FF;'>(</span><span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#39;{</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;$1:&#160;Marker</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?&#60;![a-zA-Z0-9])&#160;&#160;#&#160;Not&#160;preceded&#160;by&#160;alphanum</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?&#60;!__)&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;&#160;or&#160;by&#160;two&#160;marker&#160;chars.</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;__</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?=\S)&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;Not&#160;followed&#160;by&#160;whitespace</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?!__)&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;&#160;&#160;or&#160;two&#160;others&#160;marker&#160;chars.</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;$2:&#160;Content</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?:</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[^_]+?&#160;&#160;&#160;&#160;&#160;&#160;#&#160;Anthing&#160;not&#160;em&#160;markers.</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;|</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;Balence&#160;any&#160;regular&#160;_&#160;emphasis&#160;inside.</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?&#60;![a-zA-Z0-9])&#160;_&#160;(?=\S)&#160;(.+?)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?&#60;=\S)&#160;_&#160;(?![a-zA-Z0-9])</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;|</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;___+</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)+?</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?&#60;=\S)&#160;__&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;End&#160;mark&#160;not&#160;preceded&#160;by&#160;whitespace.</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?![a-zA-Z0-9])&#160;&#160;&#160;&#160;&#160;&#160;#&#160;Not&#160;followed&#160;by&#160;alphanum</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?!__)&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;&#160;&#160;or&#160;two&#160;others&#160;marker&#160;chars.</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;}sx&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#39;{</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(&#160;(?&#60;!\*\*)&#160;\*\*&#160;)&#160;&#160;&#160;&#160;#&#160;$1:&#160;Marker&#160;(not&#160;preceded&#160;by&#160;two&#160;*)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?=\S)&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;Not&#160;followed&#160;by&#160;whitespace</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?!\1)&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;&#160;&#160;or&#160;two&#160;others&#160;marker&#160;chars.</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;$2:&#160;Content</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?:</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[^*]+?&#160;&#160;&#160;&#160;&#160;&#160;#&#160;Anthing&#160;not&#160;em&#160;markers.</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;|</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;Balence&#160;any&#160;regular&#160;*&#160;emphasis&#160;inside.</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\*&#160;(?=\S)&#160;(.+?)&#160;(?&#60;=\S)&#160;\*</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)+?</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?&#60;=\S)&#160;\*\*&#160;&#160;&#160;&#160;&#160;&#160;#&#160;End&#160;mark&#160;not&#160;preceded&#160;by&#160;whitespace.</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;}sx&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>&#38;</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;_doItalicAndBold_strong_callback&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Then&#160;&#60;em&#62;:</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace_callback</span><span style='color: #0000FF;'>(</span><span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#39;{&#160;(&#160;(?&#60;![a-zA-Z0-9])(?&#60;!_)_&#160;)&#160;(?=\S)&#160;(?!&#160;\1)&#160;(.+?)&#160;(?&#60;=\S)&#160;\1(?![a-zA-Z0-9])&#160;}sx&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#39;{&#160;(&#160;(?&#60;!\*)\*&#160;)&#160;(?=\S)&#160;(?!&#160;\1)&#160;(.+?)&#160;(?&#60;=\S)&#160;\1&#160;}sx&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>&#38;</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;_doItalicAndBold_em_callback&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;formParagraphs<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;Params:</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;&#160;&#160;&#160;$text&#160;-&#160;string&#160;to&#160;process&#160;with&#160;html&#160;&#60;p&#62;&#160;tags</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Strip&#160;leading&#160;and&#160;trailing&#160;lines:</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace</span><span style='color: #0000FF;'>(</span><span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;/\A\n+/&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;/\n+\z/&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$grafs</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_split</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;/\n{2,}/&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #0000FF;'>-</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>,</span>&#160;PREG_SPLIT_NO_EMPTY<span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Wrap&#160;&#60;p&#62;&#160;tags&#160;and&#160;unhashify&#160;HTML&#160;blocks</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>foreach</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$grafs</b></span>&#160;<span style='color: #000099;'><b>as</b></span>&#160;<span style='color: #990000;'><b>$key</b></span>&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: #990000;'><b>$value</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$value</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>trim</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>runSpanGamut<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$value</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Check&#160;if&#160;this&#160;should&#160;be&#160;enclosed&#160;in&#160;a&#160;paragraph.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Clean&#160;tag&#160;hashes&#160;&#38;&#160;block&#160;tag&#160;hashes&#160;are&#160;left&#160;alone.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$clean_key</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$value</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$block_key</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>substr</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$value</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: purple;'>0</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: purple;'>32</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$is_p</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>!</span><span style='color: #000099;'><b>isset</b></span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>html_blocks<span style='color: #0000FF;'>[</span><span style='color: #990000;'><b>$block_key</b></span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>&#38;</span><span style='color: #0000FF;'>&#38;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>!</span><span style='color: #000099;'><b>isset</b></span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>html_cleans<span style='color: #0000FF;'>[</span><span style='color: #990000;'><b>$clean_key</b></span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$is_p</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$value</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#60;p&#62;$value&#60;/p&#62;&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$grafs</b></span><span style='color: #0000FF;'>[</span><span style='color: #990000;'><b>$key</b></span><span style='color: #0000FF;'>]</span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$value</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Join&#160;grafs&#160;in&#160;one&#160;text,&#160;then&#160;unhash&#160;HTML&#160;tags.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>implode</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#34;\n\n&#34;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$grafs</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Finish&#160;by&#160;removing&#160;any&#160;tag&#160;hashes&#160;still&#160;present&#160;in&#160;$text.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>unhash<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #0099CC;'>###&#160;Footnotes</span><br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;stripFootnotes<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Strips&#160;link&#160;definitions&#160;from&#160;text,&#160;stores&#160;the&#160;URLs&#160;and&#160;titles&#160;in</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;hash&#160;references.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$less_than_tab</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>tab_width&#160;<span style='color: #0000FF;'>-</span>&#160;<span style='color: purple;'>1</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Link&#160;defs&#160;are&#160;in&#160;the&#160;form:&#160;[^id]:&#160;url&#160;&#34;optional&#160;title&#34;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace_callback</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;{</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;^[&#160;]{0,&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$less_than_tab</b></span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;}\[\^(.+?)\][&#160;]?:&#160;&#160;#&#160;note_id&#160;=&#160;$1</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;[&#160;\t]*</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\n?&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;maybe&#160;*one*&#160;newline</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;(&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;text&#160;=&#160;$2&#160;(no&#160;blank&#160;lines&#160;allowed)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?:</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;.+&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;actual&#160;text</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;|</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;\n&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;newlines&#160;but</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?!\[\^.+?\]:\s)#&#160;negative&#160;lookahead&#160;for&#160;footnote&#160;marker.</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;(?!\n+[&#160;]{0,3}\S)#&#160;ensure&#160;line&#160;is&#160;not&#160;blank&#160;and&#160;followed</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;by&#160;non-indented&#160;content</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;)*</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;}xm&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>&#38;</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;_stripFootnotes_callback&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;_stripFootnotes_callback<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$note_id</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>footnotes<span style='color: #0000FF;'>[</span><span style='color: #990000;'><b>$note_id</b></span><span style='color: #0000FF;'>]</span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>outdent<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>2</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #008800;'>&#39;&#39;</span><span style='color: #0000FF;'>;</span>&#160;<span style='color: #0099CC;'>#&#160;String&#160;that&#160;will&#160;replace&#160;the&#160;block</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;doFootnotes<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Replace&#160;footnote&#160;references&#160;in&#160;$text&#160;[^id]&#160;with&#160;a&#160;special&#160;text-token</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;which&#160;will&#160;be&#160;can&#160;be</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;{\[\^(.+?)\]}&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#34;a\0fn:\\1\0z&#34;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;appendFootnotes<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Append&#160;footnote&#160;list&#160;to&#160;text.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace_callback</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;{a\0fn:(.*?)\0z}&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>&#38;</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;_appendFootnotes_callback&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>!</span><span style='color: #000099;'><b>empty</b></span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>footnotes_ordered<span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;\n\n&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#60;div&#160;class=\&#34;footnotes\&#34;&#62;\n&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#60;hr&#34;</span><span style='color: #0000FF;'>.</span>&#160;MARKDOWN_EMPTY_ELEMENT_SUFFIX&#160;<span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#34;\n&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#60;ol&#62;\n\n&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$attr</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#160;rev=\&#34;footnote\&#34;&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>fn_backlink_class&#160;<span style='color: #0000FF;'>!</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#34;</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$class</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>fn_backlink_class<span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$class</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>encodeAmpsAndAngles<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$class</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$class</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>str_replace</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;&#34;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;&#38;quot;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$class</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$attr</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#160;class=\&#34;$class\&#34;&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>fn_backlink_title&#160;<span style='color: #0000FF;'>!</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#34;</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$title</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>fn_backlink_title<span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$title</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>encodeAmpsAndAngles<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$title</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$title</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>str_replace</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;&#34;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;&#38;quot;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$title</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$attr</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#160;title=\&#34;$title\&#34;&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$num</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: purple;'>0</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>foreach</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>footnotes_ordered&#160;<span style='color: #000099;'><b>as</b></span>&#160;<span style='color: #990000;'><b>$note_id</b></span>&#160;<span style='color: #0000FF;'>=</span><span style='color: #0000FF;'>&#62;</span>&#160;<span style='color: #990000;'><b>$footnote</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$footnote</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;\n&#34;</span><span style='color: #0000FF;'>;</span>&#160;<span style='color: #0099CC;'>#&#160;Need&#160;to&#160;append&#160;newline&#160;before&#160;parsing.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$footnote</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>runBlockGamut<span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#34;$footnote\n&#34;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$attr2</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>str_replace</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#34;%%&#34;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #0000FF;'>+</span><span style='color: #0000FF;'>+</span><span style='color: #990000;'><b>$num</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$attr</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Add&#160;backlink&#160;to&#160;last&#160;paragraph;&#160;create&#160;new&#160;paragraph&#160;if&#160;needed.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$backlink</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#60;a&#160;href=\&#34;#fnref:$note_id\&#34;$attr2&#62;&#38;#8617;&#60;/a&#62;&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #ff0000;'>preg_match</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;{&#60;/p&#62;$}&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$footnote</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$footnote</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>substr</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$footnote</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: purple;'>0</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #0000FF;'>-</span><span style='color: purple;'>4</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>.</span>&#160;<span style='color: #008800;'>&#34;&#160;$backlink&#60;/p&#62;&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span>&#160;<span style='color: #000099;'><b>else</b></span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$footnote</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;\n\n&#60;p&#62;$backlink&#60;/p&#62;&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#60;li&#160;id=\&#34;fn:$note_id\&#34;&#62;\n&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$footnote</b></span>&#160;<span style='color: #0000FF;'>.</span>&#160;<span style='color: #008800;'>&#34;\n&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#60;/li&#62;\n\n&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#60;/ol&#62;\n&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#60;/div&#62;&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;{a\{fn:(.*?)\}z}&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;[^\\1]&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;_appendFootnotes_callback<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$node_id</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>fn_id_prefix&#160;<span style='color: #0000FF;'>.</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Create&#160;footnote&#160;marker&#160;only&#160;if&#160;it&#160;has&#160;a&#160;corresponding&#160;footnote&#160;*and*</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;the&#160;footnote&#160;hasn&#39;t&#160;been&#160;used&#160;by&#160;another&#160;marker.</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #000099;'><b>isset</b></span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>footnotes<span style='color: #0000FF;'>[</span><span style='color: #990000;'><b>$node_id</b></span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Transfert&#160;footnote&#160;content&#160;to&#160;the&#160;ordered&#160;list.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>footnotes_ordered<span style='color: #0000FF;'>[</span><span style='color: #990000;'><b>$node_id</b></span><span style='color: #0000FF;'>]</span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>footnotes<span style='color: #0000FF;'>[</span><span style='color: #990000;'><b>$node_id</b></span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #ff0000;'>unset</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>footnotes<span style='color: #0000FF;'>[</span><span style='color: #990000;'><b>$node_id</b></span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$num</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>count</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>footnotes_ordered<span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$attr</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#160;rel=\&#34;footnote\&#34;&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>fn_link_class&#160;<span style='color: #0000FF;'>!</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#34;</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$class</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>fn_link_class<span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$class</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>encodeAmpsAndAngles<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$class</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$class</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>str_replace</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;&#34;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;&#38;quot;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$class</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$attr</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#160;class=\&#34;$class\&#34;&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>fn_link_title&#160;<span style='color: #0000FF;'>!</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#34;</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$title</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>fn_link_title<span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$title</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>encodeAmpsAndAngles<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$title</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$title</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>str_replace</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;&#34;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;&#38;quot;&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$title</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$attr</b></span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#34;&#160;title=\&#34;$title\&#34;&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$attr</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>str_replace</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#34;%%&#34;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$num</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$attr</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#34;&#60;sup&#160;id=\&#34;fnref:$node_id\&#34;&#62;&#34;</span><span style='color: #0000FF;'>.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#34;&#60;a&#160;href=\&#34;#fn:$node_id\&#34;$attr&#62;$num&#60;/a&#62;&#34;</span><span style='color: #0000FF;'>.</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #008800;'>&#34;&#60;/sup&#62;&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #008800;'>&#34;[^&#34;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#34;]&#34;</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #0099CC;'>###&#160;Abbreviations&#160;###</span><br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;stripAbbreviations<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Strips&#160;abbreviations&#160;from&#160;text,&#160;stores&#160;the&#160;URLs&#160;and&#160;titles&#160;in</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;hash&#160;references.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$less_than_tab</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>tab_width&#160;<span style='color: #0000FF;'>-</span>&#160;<span style='color: purple;'>1</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;<span style='color: #0099CC;'>#&#160;Link&#160;defs&#160;are&#160;in&#160;the&#160;form:&#160;[id]*:&#160;url&#160;&#34;optional&#160;title&#34;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace_callback</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;{</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;^[&#160;]{0,&#39;</span><span style='color: #0000FF;'>.</span><span style='color: #990000;'><b>$less_than_tab</b></span><span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;}\*\[(.+?)\][&#160;]?:&#160;&#160;#&#160;abbr_id&#160;=&#160;$1</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;(.*)&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;#&#160;text&#160;=&#160;$2&#160;(no&#160;blank&#160;lines&#160;allowed)</span><br/>
<span style='color: #008800;'>&#160;&#160;&#160;&#160;&#160;&#160;}xm&#39;</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>&#38;</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;_stripAbbreviations_callback&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;_stripAbbreviations_callback<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$abbr_word</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>1</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$abbr_desc</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>2</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>abbr_matches<span style='color: #0000FF;'>[</span><span style='color: #0000FF;'>]</span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_quote</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$abbr_word</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>abbr_desciptions<span style='color: #0000FF;'>[</span><span style='color: #990000;'><b>$abbr_word</b></span><span style='color: #0000FF;'>]</span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>trim</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$abbr_desc</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #008800;'>&#39;&#39;</span><span style='color: #0000FF;'>;</span>&#160;<span style='color: #0099CC;'>#&#160;String&#160;that&#160;will&#160;replace&#160;the&#160;block</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;doAbbreviations<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#&#160;Replace&#160;footnote&#160;references&#160;in&#160;$text&#160;[^id]&#160;with&#160;a&#160;link&#160;to&#160;the&#160;footnote.</span><br/>
&#160;&#160;<span style='color: #0099CC;'>#</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>abbr_matches<span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$regex</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #008800;'>&#39;{(?&#60;!\w)(?:&#39;</span><span style='color: #0000FF;'>.</span>&#160;<span style='color: #ff0000;'>implode</span><span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#39;|&#39;</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>abbr_matches<span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>.</span><span style='color: #008800;'>&#39;)(?!\w)}&#39;</span><span style='color: #0000FF;'>;</span><br/>
&#160;<br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$text</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #ff0000;'>preg_replace_callback</span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$regex</b></span><span style='color: #0000FF;'>,</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>array</b></span><span style='color: #0000FF;'>(</span><span style='color: #0000FF;'>&#38;</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #008800;'>&#39;_doAbbreviations_callback&#39;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>,</span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$text</b></span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;<span style='color: #000099;'><b>function</b></span>&#160;_doAbbreviations_callback<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$abbr</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>0</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #000099;'><b>isset</b></span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>abbr_desciptions<span style='color: #0000FF;'>[</span><span style='color: #990000;'><b>$abbr</b></span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$desc</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>abbr_desciptions<span style='color: #0000FF;'>[</span><span style='color: #990000;'><b>$abbr</b></span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>if</b></span>&#160;<span style='color: #0000FF;'>(</span><span style='color: #000099;'><b>empty</b></span><span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$desc</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>)</span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>hashSpan<span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#34;&#60;abbr&#62;$abbr&#60;/abbr&#62;&#34;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span>&#160;<span style='color: #000099;'><b>else</b></span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #990000;'><b>$desc</b></span>&#160;<span style='color: #0000FF;'>=</span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>escapeSpecialCharsWithinTagAttributes<span style='color: #0000FF;'>(</span><span style='color: #990000;'><b>$desc</b></span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$this</b></span><span style='color: #0000FF;'>-</span><span style='color: #0000FF;'>&#62;</span>hashSpan<span style='color: #0000FF;'>(</span><span style='color: #008800;'>&#34;&#60;abbr&#160;title=\&#34;$desc\&#34;&#62;$abbr&#60;/abbr&#62;&#34;</span><span style='color: #0000FF;'>)</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span>&#160;<span style='color: #000099;'><b>else</b></span>&#160;<span style='color: #0000FF;'>{</span><br/>
&#160;&#160;&#160;&#160;&#160;&#160;<span style='color: #000099;'><b>return</b></span>&#160;<span style='color: #990000;'><b>$matches</b></span><span style='color: #0000FF;'>[</span><span style='color: purple;'>0</span><span style='color: #0000FF;'>]</span><span style='color: #0000FF;'>;</span><br/>
&#160;&#160;&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;&#160;<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
<span style='color: #0000FF;'>}</span><br/>
&#160;<br/>
&#160;<br/>
<span style='color: #0099CC;'>/*</span><br/>
<span style='color: #0099CC;'>&#160;</span><br/>
<span style='color: #0099CC;'>PHP&#160;Markdown&#160;Extra</span><br/>
<span style='color: #0099CC;'>==================</span><br/>
<span style='color: #0099CC;'>&#160;</span><br/>
<span style='color: #0099CC;'>Description</span><br/>
<span style='color: #0099CC;'>-----------</span><br/>
<span style='color: #0099CC;'>&#160;</span><br/>
<span style='color: #0099CC;'>This&#160;is&#160;a&#160;PHP&#160;port&#160;of&#160;the&#160;original&#160;Markdown&#160;formatter&#160;written&#160;in&#160;Perl</span><br/>
<span style='color: #0099CC;'>by&#160;John&#160;Gruber.&#160;This&#160;special&#160;&#34;Extra&#34;&#160;version&#160;of&#160;PHP&#160;Markdown&#160;features</span><br/>
<span style='color: #0099CC;'>further&#160;enhancements&#160;to&#160;the&#160;syntax&#160;for&#160;making&#160;additional&#160;constructs</span><br/>
<span style='color: #0099CC;'>such&#160;as&#160;tables&#160;and&#160;definition&#160;list.</span><br/>
<span style='color: #0099CC;'>&#160;</span><br/>
<span style='color: #0099CC;'>Markdown&#160;is&#160;a&#160;text-to-HTML&#160;filter;&#160;it&#160;translates&#160;an&#160;easy-to-read&#160;/</span><br/>
<span style='color: #0099CC;'>easy-to-write&#160;structured&#160;text&#160;format&#160;into&#160;HTML.&#160;Markdown&#39;s&#160;text&#160;format</span><br/>
<span style='color: #0099CC;'>is&#160;most&#160;similar&#160;to&#160;that&#160;of&#160;plain&#160;text&#160;email,&#160;and&#160;supports&#160;features&#160;such</span><br/>
<span style='color: #0099CC;'>as&#160;headers,&#160;*emphasis*,&#160;code&#160;blocks,&#160;blockquotes,&#160;and&#160;links.</span><br/>
<span style='color: #0099CC;'>&#160;</span><br/>
<span style='color: #0099CC;'>Markdown&#39;s&#160;syntax&#160;is&#160;designed&#160;not&#160;as&#160;a&#160;generic&#160;markup&#160;language,&#160;but</span><br/>
<span style='color: #0099CC;'>specifically&#160;to&#160;serve&#160;as&#160;a&#160;front-end&#160;to&#160;(X)HTML.&#160;You&#160;can&#160;use&#160;span-level</span><br/>
<span style='color: #0099CC;'>HTML&#160;tags&#160;anywhere&#160;in&#160;a&#160;Markdown&#160;document,&#160;and&#160;you&#160;can&#160;use&#160;block&#160;level</span><br/>
<span style='color: #0099CC;'>HTML&#160;tags&#160;(like&#160;&#60;div&#62;&#160;and&#160;&#60;table&#62;&#160;as&#160;well).</span><br/>
<span style='color: #0099CC;'>&#160;</span><br/>
<span style='color: #0099CC;'>For&#160;more&#160;information&#160;about&#160;Markdown&#39;s&#160;syntax,&#160;see:</span><br/>
<span style='color: #0099CC;'>&#160;</span><br/>
<span style='color: #0099CC;'>&#60;http://daringfireball.net/projects/markdown/&#62;</span><br/>
<span style='color: #0099CC;'>&#160;</span><br/>
<span style='color: #0099CC;'>&#160;</span><br/>
<span style='color: #0099CC;'>Bugs</span><br/>
<span style='color: #0099CC;'>----</span><br/>
<span style='color: #0099CC;'>&#160;</span><br/>
<span style='color: #0099CC;'>To&#160;file&#160;bug&#160;reports&#160;please&#160;send&#160;email&#160;to:</span><br/>
<span style='color: #0099CC;'>&#160;</span><br/>
<span style='color: #0099CC;'>&#60;michel.fortin@michelf.com&#62;</span><br/>
<span style='color: #0099CC;'>&#160;</span><br/>
<span style='color: #0099CC;'>Please&#160;include&#160;with&#160;your&#160;report:&#160;(1)&#160;the&#160;example&#160;input;&#160;(2)&#160;the&#160;output&#160;you</span><br/>
<span style='color: #0099CC;'>expected;&#160;(3)&#160;the&#160;output&#160;Markdown&#160;actually&#160;produced.</span><br/>
<span style='color: #0099CC;'>&#160;</span><br/>
<span style='color: #0099CC;'>&#160;</span><br/>
<span style='color: #0099CC;'>Version&#160;History</span><br/>
<span style='color: #0099CC;'>---------------</span><br/>
<span style='color: #0099CC;'>&#160;</span><br/>
<span style='color: #0099CC;'>See&#160;Readme&#160;file&#160;for&#160;details.</span><br/>
<span style='color: #0099CC;'>&#160;</span><br/>
<span style='color: #0099CC;'>Extra&#160;1.1.2&#160;(7&#160;Feb&#160;2007)</span><br/>
<span style='color: #0099CC;'>&#160;</span><br/>
<span style='color: #0099CC;'>Extra&#160;1.1.1&#160;(28&#160;Dec&#160;2006)</span><br/>
<span style='color: #0099CC;'>&#160;</span><br/>
<span style='color: #0099CC;'>Extra&#160;1.1&#160;(1&#160;Dec&#160;2006)</span><br/>
<span style='color: #0099CC;'>&#160;</span><br/>
<span style='color: #0099CC;'>Extra&#160;1.0.1&#160;(9&#160;Dec&#160;2005)</span><br/>
<span style='color: #0099CC;'>&#160;</span><br/>
<span style='color: #0099CC;'>Extra&#160;1.0&#160;(5&#160;Sep&#160;2005)</span><br/>
<span style='color: #0099CC;'>&#160;</span><br/>
<span style='color: #0099CC;'>&#160;</span><br/>
<span style='color: #0099CC;'>Copyright&#160;and&#160;License</span><br/>
<span style='color: #0099CC;'>---------------------</span><br/>
<span style='color: #0099CC;'>&#160;</span><br/>
<span style='color: #0099CC;'>PHP&#160;Markdown&#160;&#38;&#160;Extra</span><br/>
<span style='color: #0099CC;'>Copyright&#160;(c)&#160;2004-2007&#160;Michel&#160;Fortin</span><br/>
<span style='color: #0099CC;'>&#60;http://www.michelf.com/&#62;</span><br/>
<span style='color: #0099CC;'>All&#160;rights&#160;reserved.</span><br/>
<span style='color: #0099CC;'>&#160;</span><br/>
<span style='color: #0099CC;'>Based&#160;on&#160;Markdown</span><br/>
<span style='color: #0099CC;'>Copyright&#160;(c)&#160;2003-2006&#160;John&#160;Gruber</span><br/>
<span style='color: #0099CC;'>&#60;http://daringfireball.net/&#62;</span><br/>
<span style='color: #0099CC;'>All&#160;rights&#160;reserved.</span><br/>
<span style='color: #0099CC;'>&#160;</span><br/>
<span style='color: #0099CC;'>Redistribution&#160;and&#160;use&#160;in&#160;source&#160;and&#160;binary&#160;forms,&#160;with&#160;or&#160;without</span><br/>
<span style='color: #0099CC;'>modification,&#160;are&#160;permitted&#160;provided&#160;that&#160;the&#160;following&#160;conditions&#160;are</span><br/>
<span style='color: #0099CC;'>met:</span><br/>
<span style='color: #0099CC;'>&#160;</span><br/>
<span style='color: #0099CC;'>*&#160;&#160;Redistributions&#160;of&#160;source&#160;code&#160;must&#160;retain&#160;the&#160;above&#160;copyright&#160;notice,</span><br/>
<span style='color: #0099CC;'>&#160;&#160;this&#160;list&#160;of&#160;conditions&#160;and&#160;the&#160;following&#160;disclaimer.</span><br/>
<span style='color: #0099CC;'>&#160;</span><br/>
<span style='color: #0099CC;'>*&#160;&#160;Redistributions&#160;in&#160;binary&#160;form&#160;must&#160;reproduce&#160;the&#160;above&#160;copyright</span><br/>
<span style='color: #0099CC;'>&#160;&#160;notice,&#160;this&#160;list&#160;of&#160;conditions&#160;and&#160;the&#160;following&#160;disclaimer&#160;in&#160;the</span><br/>
<span style='color: #0099CC;'>&#160;&#160;documentation&#160;and/or&#160;other&#160;materials&#160;provided&#160;with&#160;the&#160;distribution.</span><br/>
<span style='color: #0099CC;'>&#160;</span><br/>
<span style='color: #0099CC;'>*&#160;&#160;Neither&#160;the&#160;name&#160;&#34;Markdown&#34;&#160;nor&#160;the&#160;names&#160;of&#160;its&#160;contributors&#160;may</span><br/>
<span style='color: #0099CC;'>&#160;&#160;be&#160;used&#160;to&#160;endorse&#160;or&#160;promote&#160;products&#160;derived&#160;from&#160;this&#160;software</span><br/>
<span style='color: #0099CC;'>&#160;&#160;without&#160;specific&#160;prior&#160;written&#160;permission.</span><br/>
<span style='color: #0099CC;'>&#160;</span><br/>
<span style='color: #0099CC;'>This&#160;software&#160;is&#160;provided&#160;by&#160;the&#160;copyright&#160;holders&#160;and&#160;contributors&#160;&#34;as</span><br/>
<span style='color: #0099CC;'>is&#34;&#160;and&#160;any&#160;express&#160;or&#160;implied&#160;warranties,&#160;including,&#160;but&#160;not&#160;limited</span><br/>
<span style='color: #0099CC;'>to,&#160;the&#160;implied&#160;warranties&#160;of&#160;merchantability&#160;and&#160;fitness&#160;for&#160;a</span><br/>
<span style='color: #0099CC;'>particular&#160;purpose&#160;are&#160;disclaimed.&#160;In&#160;no&#160;event&#160;shall&#160;the&#160;copyright&#160;owner</span><br/>
<span style='color: #0099CC;'>or&#160;contributors&#160;be&#160;liable&#160;for&#160;any&#160;direct,&#160;indirect,&#160;incidental,&#160;special,</span><br/>
<span style='color: #0099CC;'>exemplary,&#160;or&#160;consequential&#160;damages&#160;(including,&#160;but&#160;not&#160;limited&#160;to,</span><br/>
<span style='color: #0099CC;'>procurement&#160;of&#160;substitute&#160;goods&#160;or&#160;services;&#160;loss&#160;of&#160;use,&#160;data,&#160;or</span><br/>
<span style='color: #0099CC;'>profits;&#160;or&#160;business&#160;interruption)&#160;however&#160;caused&#160;and&#160;on&#160;any&#160;theory&#160;of</span><br/>
<span style='color: #0099CC;'>liability,&#160;whether&#160;in&#160;contract,&#160;strict&#160;liability,&#160;or&#160;tort&#160;(including</span><br/>
<span style='color: #0099CC;'>negligence&#160;or&#160;otherwise)&#160;arising&#160;in&#160;any&#160;way&#160;out&#160;of&#160;the&#160;use&#160;of&#160;this</span><br/>
<span style='color: #0099CC;'>software,&#160;even&#160;if&#160;advised&#160;of&#160;the&#160;possibility&#160;of&#160;such&#160;damage.</span><br/>
<span style='color: #0099CC;'>&#160;</span><br/>
<span style='color: #0099CC;'>*/</span><br/>
<span style='color: #003366;'>?&#62;</span><br/>
